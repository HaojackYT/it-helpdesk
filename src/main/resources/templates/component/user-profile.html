<!-- User Profile Component (fragment) -->
<!-- Place this file in templates/component and include it where needed with Thymeleaf or paste content into page -->
<div id="userProfileModal" th:fragment="userProfile" class="user-profile-modal" style="display:none;">
    <div class="user-profile-card">
        <button class="user-profile-close" aria-label="Close profile">&times;</button>
        <div class="user-profile-header">
            <div class="avatar"> 
                <svg viewBox="0 0 24 24" width="56" height="56" fill="#fff">
                    <circle cx="12" cy="8" r="4"></circle>
                    <path d="M4 20c0-4 4-6 8-6s8 2 8 6"/>
                </svg>
            </div>
            <div class="user-name" id="profileFullName">User Name</div>
            <button class="user-profile-edit" title="Edit profile">âœŽ</button>
        </div>

        <div class="user-profile-body">
            <div class="profile-row"><div class="label">Username</div><div class="value" id="profileUsername">itsupport1</div></div>
            <div class="profile-row"><div class="label">Current Password</div><div class="value" id="profilePassword">**********</div></div>
            <div class="profile-row"><div class="label">Email</div><div class="value" id="profileEmail">john.it@company.com</div></div>
            <div class="profile-row"><div class="label">Roles</div><div class="value" id="profileRoles">IT Support</div></div>
            <div class="profile-row"><div class="label">Status</div><div class="value" id="profileStatus">Active</div></div>
            <div class="profile-row"><div class="label">Department</div><div class="value" id="profileDepartment">IT Department</div></div>
            <div class="profile-row"><div class="label">Created at</div><div class="value" id="profileCreatedAt">2026-01-12 15:17:18</div></div>
        </div>
    </div>

    <script>
        // Expose a global function to show the profile modal and populate data
        function showUserProfileModal(user) {
            try {
                const modal = document.getElementById('userProfileModal');
                if (!modal) return;

                        const raw = user || JSON.parse(localStorage.getItem('user_info') || localStorage.getItem('USER') || '{}');

                        // helper to format roles: remove ROLE_ prefix and replace underscores with spaces
                        function formatRoleString(role) {
                            if (!role) return '';
                            return role.toString().replace(/^ROLE_/, '').replace(/_/g, ' ').toUpperCase();
                        }

                        // populate simple fields first
                        document.getElementById('profileFullName').textContent = raw.fullName || raw.fullname || raw.username || 'User';
                        document.getElementById('profileUsername').textContent = raw.username || '';
                        document.getElementById('profileEmail').textContent = raw.email || '';
                        // roles may be array or single string
                        let rolesDisplay = '';
                        if (raw.roles && Array.isArray(raw.roles)) {
                            rolesDisplay = raw.roles.map(formatRoleString).join(', ');
                        } else if (raw.roles) {
                            rolesDisplay = formatRoleString(raw.roles);
                        }
                        document.getElementById('profileRoles').textContent = rolesDisplay || '';
                        document.getElementById('profileStatus').textContent = raw.status || 'Active';
                        document.getElementById('profileDepartment').textContent = raw.department || '';

                        // createdAt: try multiple property names; if not present, fetch from /api/users/me
                        const createdAtValue = raw.createdAt || raw.created_at || raw.created || raw.createdAtIso || raw.created_at_iso || '';
                        const createdEl = document.getElementById('profileCreatedAt');
                        if (createdAtValue) {
                            createdEl.textContent = createdAtValue;
                            modal.style.display = 'flex';
                        } else {
                            // attempt to fetch profile from server (requires auth)
                            (async function fetchFullProfile() {
                                try {
                                    const token = localStorage.getItem('auth_token') || localStorage.getItem('TOKEN');
                                    const tokenType = localStorage.getItem('token_type') || localStorage.getItem('TOKEN_TYPE') || 'Bearer';
                                    const headers = { 'Accept': 'application/json' };
                                    if (token) headers['Authorization'] = `${tokenType} ${token}`;

                                    const resp = await fetch('/api/users/me', { headers });
                                    if (!resp.ok) throw new Error('Failed to fetch profile');
                                    const body = await resp.json();
                                    const serverUser = (body && body.success && body.data) ? body.data : body;
                                    if (serverUser) {
                                        // update fields from server response
                                        document.getElementById('profileFullName').textContent = serverUser.fullName || serverUser.fullname || serverUser.username || document.getElementById('profileFullName').textContent;
                                        document.getElementById('profileUsername').textContent = serverUser.username || document.getElementById('profileUsername').textContent;
                                        document.getElementById('profileEmail').textContent = serverUser.email || document.getElementById('profileEmail').textContent;
                                        if (serverUser.roles && Array.isArray(serverUser.roles)) {
                                            document.getElementById('profileRoles').textContent = serverUser.roles.map(formatRoleString).join(', ');
                                        }
                                        document.getElementById('profileStatus').textContent = serverUser.status || document.getElementById('profileStatus').textContent;
                                        document.getElementById('profileDepartment').textContent = serverUser.department || document.getElementById('profileDepartment').textContent;
                                        createdEl.textContent = serverUser.createdAt || serverUser.created_at || serverUser.created || '';
                                    }
                                } catch (err) {
                                    console.warn('Could not fetch full profile', err);
                                } finally {
                                    modal.style.display = 'flex';
                                }
                            })();
                        }
            } catch (e) {
                console.warn('Unable to show user profile', e);
            }
        }

        // hide modal on close or background click
        (function() {
            const modal = document.getElementById('userProfileModal');
            if (!modal) return;
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.style.display = 'none';
            });
            const closeBtn = modal.querySelector('.user-profile-close');
            closeBtn?.addEventListener('click', () => { modal.style.display = 'none'; });

            const editBtn = modal.querySelector('.user-profile-edit');
            editBtn?.addEventListener('click', () => { alert('Edit profile - feature not implemented'); });
        })();
    </script>
</div>
