<!-- User Profile Component (fragment) -->
<!-- Place this file in templates/component and include it where needed with Thymeleaf or paste content into page -->
<div id="userProfileModal" th:fragment="userProfile" class="user-profile-modal" style="display:none;">
    <div class="user-profile-card">
        <button class="user-profile-close" aria-label="Close profile">&times;</button>
        <div class="user-profile-header">
            <div class="avatar"> 
                <svg viewBox="0 0 24 24" width="56" height="56" fill="#fff">
                    <circle cx="12" cy="8" r="4"></circle>
                    <path d="M4 20c0-4 4-6 8-6s8 2 8 6"/>
                </svg>
            </div>
            <div class="user-name" id="profileFullName">User Name</div>
            <button class="user-profile-edit" title="Edit profile">✎</button>
        </div>

        <div class="user-profile-body">
            <div class="profile-row"><div class="label">Username</div><div class="value" id="profileUsername">itsupport1</div></div>
            <div class="profile-row"><div class="label">Current Password</div><div class="value" id="profilePassword">**********</div></div>
            <div class="profile-row"><div class="label">Email</div><div class="value" id="profileEmail">john.it@company.com</div></div>
            <div class="profile-row"><div class="label">Roles</div><div class="value" id="profileRoles">IT Support</div></div>
            <div class="profile-row"><div class="label">Status</div><div class="value" id="profileStatus">Active</div></div>
            <div class="profile-row"><div class="label">Department</div><div class="value" id="profileDepartment">IT Department</div></div>
            <div class="profile-row"><div class="label">Created at</div><div class="value" id="profileCreatedAt">2026-01-12 15:17:18</div></div>
        </div>
    </div>

    <script>
        // Expose a global function to show the profile modal and populate data
        var _currentProfile = null;
        function showUserProfileModal(user) {
            try {
                const modal = document.getElementById('userProfileModal');
                if (!modal) return;

                        const raw = user || JSON.parse(localStorage.getItem('user_info') || localStorage.getItem('USER') || '{}');

                        // helper to format roles: remove ROLE_ prefix and replace underscores with spaces
                        function formatRoleString(role) {
                            if (!role) return '';
                            return role.toString().replace(/^ROLE_/, '').replace(/_/g, ' ').toUpperCase();
                        }

                        // populate simple fields first
                        document.getElementById('profileFullName').textContent = raw.fullName || raw.fullname || raw.username || 'User';
                        document.getElementById('profileUsername').textContent = raw.username || '';
                        document.getElementById('profileEmail').textContent = raw.email || '';
                        // roles may be array or single string
                        let rolesDisplay = '';
                        if (raw.roles && Array.isArray(raw.roles)) {
                            rolesDisplay = raw.roles.map(formatRoleString).join(', ');
                        } else if (raw.roles) {
                            rolesDisplay = formatRoleString(raw.roles);
                        }
                        document.getElementById('profileRoles').textContent = rolesDisplay || '';
                        document.getElementById('profileStatus').textContent = raw.status || 'Active';
                        document.getElementById('profileDepartment').textContent = raw.department || '';

                        // createdAt: always show Null for test accounts
                        const createdEl = document.getElementById('profileCreatedAt');
                        createdEl.textContent = 'Null';
                        modal.style.display = 'flex';
            } catch (e) {
                console.warn('Unable to show user profile', e);
            }
        }

        // hide modal on close or background click
        (function() {
            const modal = document.getElementById('userProfileModal');
            if (!modal) return;
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.style.display = 'none';
            });
            const closeBtn = modal.querySelector('.user-profile-close');
            closeBtn?.addEventListener('click', () => { modal.style.display = 'none'; });

            const editBtn = modal.querySelector('.user-profile-edit');
            editBtn?.addEventListener('click', async () => {
                try {
                    const token = localStorage.getItem('auth_token') || localStorage.getItem('TOKEN');
                    const tokenType = localStorage.getItem('token_type') || localStorage.getItem('TOKEN_TYPE') || 'Bearer';
                    const headers = { 'Accept': 'application/json' };
                    if (token) headers['Authorization'] = `${tokenType} ${token}`;

                    const resp = await fetch('/api/users/me', { headers });
                    if (!resp.ok) throw new Error('Failed to fetch profile');
                    const body = await resp.json();
                    const serverUser = (body && body.success && body.data) ? body.data : body;
                    _currentProfile = serverUser;
                    openInlineEditModal(serverUser);
                } catch (err) {
                    console.error('Could not open edit modal', err);
                    alert('Không thể mở chỉnh sửa hồ sơ. Vui lòng thử lại.');
                }
            });
        })();
        
        // Inline edit modal (built into this fragment)
        (function() {
            const modalHtml = `
                <div class="modal-overlay" id="inlineEditUserModal" style="display:none;">
                    <div class="modal-container">
                        <div class="modal-header">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <div class="edit-avatar" style="width:56px;height:56px;background:#ccc;border-radius:50%;display:flex;align-items:center;justify-content:center;">
                                    <svg viewBox="0 0 24 24" width="36" height="36" fill="#000">
                                        <circle cx="12" cy="8" r="4"></circle>
                                        <path d="M4 20c0-4 4-6 8-6s8 2 8 6"/>
                                    </svg>
                                </div>
                                <h3>Edit User Profile</h3>
                            </div>
                            <button class="modal-close" aria-label="Close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="inlineEditUserForm">
                                <div class="form-row"><label>Full name</label><input id="ieFullName" type="text" autocomplete="name"/></div>
                                <div class="form-row"><label>Current password</label><input id="ieCurrentPassword" type="password" autocomplete="current-password"/></div>
                                <div class="form-row"><label>New password</label><input id="ieNewPassword" type="password" autocomplete="new-password"/></div>
                                <div class="form-row"><label>Confirm new password</label><input id="ieConfirmPassword" type="password" autocomplete="new-password"/></div>
                                <div style="text-align:right; margin-top:12px;"><button type="submit">Save</button></div>
                            </form>
                        </div>
                    </div>
                </div>`;

            const wrapper = document.createElement('div');
            wrapper.innerHTML = modalHtml;
            document.getElementById('userProfileModal').appendChild(wrapper);

            const ieModal = document.getElementById('inlineEditUserModal');
            const ieClose = ieModal.querySelector('.modal-close');
            const ieForm = document.getElementById('inlineEditUserForm');

            ieClose.addEventListener('click', () => { ieModal.style.display = 'none'; });
            ieModal.addEventListener('click', (e) => { if (e.target === ieModal) ieModal.style.display = 'none'; });

            window.openInlineEditModal = function(user) {
                if (!user) return;
                document.getElementById('ieFullName').value = user.fullName || user.fullname || '';
                document.getElementById('ieCurrentPassword').value = '';
                document.getElementById('ieNewPassword').value = '';
                document.getElementById('ieConfirmPassword').value = '';
                ieModal.style.display = 'flex';
            }

            ieForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    if (!_currentProfile || !_currentProfile.id) {
                        alert('User id missing');
                        return;
                    }


                    // Build payload: allow changing password and fullName
                    const fullName = document.getElementById('ieFullName').value || '';
                    const currentPwd = document.getElementById('ieCurrentPassword').value || '';
                    const newPwd = document.getElementById('ieNewPassword').value || '';
                    const confirmPwd = document.getElementById('ieConfirmPassword').value || '';

                    // Validation: if user wants to change password, require current and match confirm
                    if (newPwd) {
                        if (!currentPwd) {
                            alert('Vui lòng nhập mật khẩu hiện tại để đổi mật khẩu');
                            return;
                        }
                        if (newPwd.length < 6) {
                            alert('Mật khẩu mới phải có ít nhất 6 ký tự');
                            return;
                        }
                        if (newPwd !== confirmPwd) {
                            alert('Mật khẩu mới và xác nhận không khớp');
                            return;
                        }
                    }

                    const payload = {};
                    if (fullName && fullName.trim()) payload.fullName = fullName.trim();
                    if (newPwd) payload.password = newPwd;

                    // Check if there's anything to update
                    if (Object.keys(payload).length === 0) {
                        alert('Không có thay đổi để lưu');
                        return;
                    }

                    const token = localStorage.getItem('auth_token') || localStorage.getItem('TOKEN');
                    const tokenType = localStorage.getItem('token_type') || localStorage.getItem('TOKEN_TYPE') || 'Bearer';
                    const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' };
                    if (token) headers['Authorization'] = `${tokenType} ${token}`;

                    // Use /api/users/me so authenticated user can update own profile
                    const resp = await fetch(`/api/users/me`, {
                        method: 'PUT', headers, body: JSON.stringify(payload)
                    });

                    const respBody = await resp.json().catch(()=>null);
                    if (!resp.ok) {
                        const err = (respBody && respBody.message) ? respBody.message : 'Cập nhật thất bại';
                        console.error('Update failed', resp.status, respBody);
                        alert(err);
                        return;
                    }

                    const updated = (respBody && respBody.success && respBody.data) ? respBody.data : respBody;
                    if (updated) {
                        document.getElementById('profileFullName').textContent = updated.fullName || document.getElementById('profileFullName').textContent;
                        document.getElementById('profileEmail').textContent = updated.email || document.getElementById('profileEmail').textContent;
                        document.getElementById('profileDepartment').textContent = updated.department || document.getElementById('profileDepartment').textContent;
                        document.getElementById('profileStatus').textContent = updated.status || document.getElementById('profileStatus').textContent;
                    }

                    ieModal.style.display = 'none';
                    alert('Cập nhật hồ sơ thành công');
                } catch (err) {
                    console.error('Error updating profile', err);
                    const msg = (err && err.message) ? err.message : 'Có lỗi xảy ra';
                    alert(msg);
                }
            });
        })();
    </script>
</div>
