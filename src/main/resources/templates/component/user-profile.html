<!-- User Profile Component (fragment) -->
<!-- Place this file in templates/component and include it where needed with Thymeleaf or paste content into page -->
<div id="userProfileModal" th:fragment="userProfile" class="user-profile-modal" style="display:none;">
    <div class="user-profile-card">
        <button class="user-profile-close" aria-label="Close profile">&times;</button>
        <div class="user-profile-header">
            <div class="avatar"> 
                <svg viewBox="0 0 24 24" width="56" height="56" fill="#fff">
                    <circle cx="12" cy="8" r="4"></circle>
                    <path d="M4 20c0-4 4-6 8-6s8 2 8 6"/>
                </svg>
            </div>
            <div class="user-name" id="profileFullName">User Name</div>
            <button class="user-profile-edit" title="Edit profile">✎</button>
        </div>

        <div class="user-profile-body">
            <div class="profile-row"><div class="label">Username</div><div class="value" id="profileUsername">itsupport1</div></div>
            <div class="profile-row"><div class="label">Current Password</div><div class="value" id="profilePassword">**********</div></div>
            <div class="profile-row"><div class="label">Email</div><div class="value" id="profileEmail">john.it@company.com</div></div>
            <div class="profile-row"><div class="label">Roles</div><div class="value" id="profileRoles">IT Support</div></div>
            <div class="profile-row"><div class="label">Status</div><div class="value" id="profileStatus">Active</div></div>
            <div class="profile-row"><div class="label">Department</div><div class="value" id="profileDepartment">IT Department</div></div>
            <div class="profile-row"><div class="label">Created at</div><div class="value" id="profileCreatedAt">2026-01-12 15:17:18</div></div>
        </div>
    </div>

    <script>
        // Expose a global function to show the profile modal and populate data
        var _currentProfile = null;
        function showUserProfileModal(user) {
            try {
                const modal = document.getElementById('userProfileModal');
                if (!modal) return;

                        const raw = user || JSON.parse(sessionStorage.getItem('user_info') || sessionStorage.getItem('USER') || '{}');

                        // helper to format roles: remove ROLE_ prefix and replace underscores with spaces
                        function formatRoleString(role) {
                            if (!role) return '';
                            return role.toString().replace(/^ROLE_/, '').replace(/_/g, ' ').toUpperCase();
                        }

                        // populate simple fields first
                        document.getElementById('profileFullName').textContent = raw.fullName || raw.fullname || raw.username || 'User';
                        document.getElementById('profileUsername').textContent = raw.username || '';
                        document.getElementById('profileEmail').textContent = raw.email || '';
                        // roles may be array or single string
                        let rolesDisplay = '';
                        if (raw.roles && Array.isArray(raw.roles)) {
                            rolesDisplay = raw.roles.map(formatRoleString).join(', ');
                        } else if (raw.roles) {
                            rolesDisplay = formatRoleString(raw.roles);
                        }
                        document.getElementById('profileRoles').textContent = rolesDisplay || '';
                        document.getElementById('profileStatus').textContent = raw.status || 'Active';
                        document.getElementById('profileDepartment').textContent = raw.department || '';

                        // createdAt: always show Null for test accounts
                        const createdEl = document.getElementById('profileCreatedAt');
                        createdEl.textContent = 'Null';
                        modal.style.display = 'flex';
            } catch (e) {
                console.warn('Unable to show user profile', e);
            }
        }

        // Initialize user profile modal - wait for DOM to be ready
        function initUserProfileModal() {
            const modal = document.getElementById('userProfileModal');
            if (!modal) {
                console.warn('userProfileModal not found, retrying...');
                setTimeout(initUserProfileModal, 100);
                return;
            }

            console.log('User profile modal found, initializing...');

            // hide modal on close or background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.style.display = 'none';
            });
            const closeBtn = modal.querySelector('.user-profile-close');
            closeBtn?.addEventListener('click', () => { modal.style.display = 'none'; });

            const editBtn = modal.querySelector('.user-profile-edit');
            if (editBtn) {
                console.log('Edit button found, attaching event listener...');
                editBtn.addEventListener('click', async () => {
                    console.log('Edit button clicked!');
                    try {
                        const token = sessionStorage.getItem('auth_token') || sessionStorage.getItem('TOKEN');
                        const tokenType = sessionStorage.getItem('token_type') || sessionStorage.getItem('TOKEN_TYPE') || 'Bearer';
                        const headers = { 'Accept': 'application/json' };
                        if (token) headers['Authorization'] = `${tokenType} ${token}`;

                        const resp = await fetch('/api/users/me', { headers });
                        if (!resp.ok) throw new Error('Failed to fetch profile');
                        const body = await resp.json();
                        const serverUser = (body && body.success && body.data) ? body.data : body;
                        _currentProfile = serverUser;
                        console.log('Opening edit modal with user:', serverUser);
                        openInlineEditModal(serverUser);
                    } catch (err) {
                        console.error('Could not open edit modal', err);
                        alert('Không thể mở chỉnh sửa hồ sơ. Vui lòng thử lại.');
                    }
                });
            } else {
                console.error('Edit button not found!');
            }

            // Create inline edit modal
            createInlineEditModal();
        }
        
        // Inline edit modal (built into this fragment)
        function createInlineEditModal() {
            console.log('Creating inline edit modal...');
            const modalHtml = `
                <div id="inlineEditUserModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:99999;align-items:center;justify-content:center;">
                    <div style="max-width:450px;width:90%;background:#fff;border-radius:10px;padding:0;box-shadow:0 10px 30px rgba(0,0,0,0.2);">
                        <div style="background:linear-gradient(90deg,#3ec9b0,#3aa79a);color:#fff;padding:16px 20px;display:flex;justify-content:space-between;align-items:center;border-radius:10px 10px 0 0;">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <div style="width:56px;height:56px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center;">
                                    <svg viewBox="0 0 24 24" width="36" height="36" fill="#fff">
                                        <circle cx="12" cy="8" r="4"></circle>
                                        <path d="M4 20c0-4 4-6 8-6s8 2 8 6"/>
                                    </svg>
                                </div>
                                <h3 style="margin:0;font-size:18px;">Edit User Profile</h3>
                            </div>
                            <button id="ieCloseBtn" type="button" style="background:transparent;border:none;color:#fff;font-size:28px;cursor:pointer;padding:0;line-height:1;">&times;</button>
                        </div>
                        <div style="padding:20px;background:#f7f7f7;border-radius:0 0 10px 10px;">
                            <form id="inlineEditUserForm">
                                <div style="margin-bottom:15px;"><label style="display:block;margin-bottom:5px;font-weight:600;color:#333;">Full name</label><input id="ieFullName" type="text" autocomplete="name" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box;"/></div>
                                <div style="margin-bottom:15px;"><label style="display:block;margin-bottom:5px;font-weight:600;color:#333;">Current password</label><input id="ieCurrentPassword" type="password" autocomplete="current-password" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box;"/></div>
                                <div style="margin-bottom:15px;"><label style="display:block;margin-bottom:5px;font-weight:600;color:#333;">New password</label><input id="ieNewPassword" type="password" autocomplete="new-password" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box;"/></div>
                                <div style="margin-bottom:15px;"><label style="display:block;margin-bottom:5px;font-weight:600;color:#333;">Confirm new password</label><input id="ieConfirmPassword" type="password" autocomplete="new-password" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;box-sizing:border-box;"/></div>
                                <div style="text-align:right; margin-top:16px;"><button type="submit" style="background:#3ec9b0;color:#fff;border:none;padding:12px 24px;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;">Save</button></div>
                            </form>
                        </div>
                    </div>
                </div>`;

            const userProfileModal = document.getElementById('userProfileModal');
            if (!userProfileModal) {
                console.error('Cannot create inline edit modal: userProfileModal not found!');
                return;
            }

            const wrapper = document.createElement('div');
            wrapper.innerHTML = modalHtml;
            // Append to body instead of userProfileModal to avoid z-index stacking issues
            document.body.appendChild(wrapper.firstElementChild);

            const ieModal = document.getElementById('inlineEditUserModal');
            if (!ieModal) {
                console.error('Failed to create inlineEditUserModal!');
                return;
            }

            console.log('Inline edit modal created successfully and appended to body');

            const ieClose = document.getElementById('ieCloseBtn');
            const ieForm = document.getElementById('inlineEditUserForm');

            ieClose?.addEventListener('click', () => { 
                console.log('Closing edit modal');
                ieModal.style.display = 'none'; 
            });
            ieModal.addEventListener('click', (e) => { 
                if (e.target === ieModal) {
                    console.log('Closing edit modal (clicked outside)');
                    ieModal.style.display = 'none';
                }
            });

            window.openInlineEditModal = function(user) {
                console.log('openInlineEditModal called with user:', user);
                if (!user) {
                    console.error('No user provided to openInlineEditModal');
                    return;
                }
                document.getElementById('ieFullName').value = user.fullName || user.fullname || '';
                document.getElementById('ieCurrentPassword').value = '';
                document.getElementById('ieNewPassword').value = '';
                document.getElementById('ieConfirmPassword').value = '';
                console.log('Showing edit modal');
                ieModal.style.display = 'flex';
            }

            ieForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    if (!_currentProfile || !_currentProfile.id) {
                        alert('User id missing');
                        return;
                    }


                    // Build payload: allow changing password and fullName
                    const fullName = document.getElementById('ieFullName').value || '';
                    const currentPwd = document.getElementById('ieCurrentPassword').value || '';
                    const newPwd = document.getElementById('ieNewPassword').value || '';
                    const confirmPwd = document.getElementById('ieConfirmPassword').value || '';

                    // Validation: if user wants to change password, require current and match confirm
                    if (newPwd) {
                        if (!currentPwd) {
                            alert('Vui lòng nhập mật khẩu hiện tại để đổi mật khẩu');
                            return;
                        }
                        if (newPwd.length < 6) {
                            alert('Mật khẩu mới phải có ít nhất 6 ký tự');
                            return;
                        }
                        if (newPwd !== confirmPwd) {
                            alert('Mật khẩu mới và xác nhận không khớp');
                            return;
                        }
                    }

                    const payload = {};
                    if (fullName && fullName.trim()) payload.fullName = fullName.trim();
                    if (newPwd) payload.password = newPwd;

                    // Check if there's anything to update
                    if (Object.keys(payload).length === 0) {
                        alert('Không có thay đổi để lưu');
                        return;
                    }

                    const token = sessionStorage.getItem('auth_token') || sessionStorage.getItem('TOKEN');
                    const tokenType = sessionStorage.getItem('token_type') || sessionStorage.getItem('TOKEN_TYPE') || 'Bearer';
                    const headers = { 'Content-Type': 'application/json', 'Accept': 'application/json' };
                    if (token) headers['Authorization'] = `${tokenType} ${token}`;

                    // Use /api/users/me so authenticated user can update own profile
                    const resp = await fetch(`/api/users/me`, {
                        method: 'PUT', headers, body: JSON.stringify(payload)
                    });

                    const respBody = await resp.json().catch(()=>null);
                    if (!resp.ok) {
                        const err = (respBody && respBody.message) ? respBody.message : 'Cập nhật thất bại';
                        console.error('Update failed', resp.status, respBody);
                        alert(err);
                        return;
                    }

                    const updated = (respBody && respBody.success && respBody.data) ? respBody.data : respBody;
                    if (updated) {
                        document.getElementById('profileFullName').textContent = updated.fullName || document.getElementById('profileFullName').textContent;
                        document.getElementById('profileEmail').textContent = updated.email || document.getElementById('profileEmail').textContent;
                        document.getElementById('profileDepartment').textContent = updated.department || document.getElementById('profileDepartment').textContent;
                        document.getElementById('profileStatus').textContent = updated.status || document.getElementById('profileStatus').textContent;
                    }

                    ieModal.style.display = 'none';
                    alert('Cập nhật hồ sơ thành công');
                } catch (err) {
                    console.error('Error updating profile', err);
                    const msg = (err && err.message) ? err.message : 'Có lỗi xảy ra';
                    alert(msg);
                }
            });
        }

        // Auto-initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initUserProfileModal);
        } else {
            initUserProfileModal();
        }
    </script>
</div>
