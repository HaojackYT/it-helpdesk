<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Helpdesk - Admin Dashboard</title>
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/admin/admin-sidebar.css">
    <link rel="stylesheet" href="/css/admin/admin-dashboard.css">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p>Loading dashboard...</p>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1 class="header-title">IT Helpdesk</h1>
            <div class="header-actions">
                <span id="userGreeting" class="user-greeting"></span>
                <button class="btn-icon btn-user" aria-label="User profile" title="User Profile">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </button>
                <button class="btn-icon btn-logout" aria-label="Logout" title="Logout">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <aside class="sidebar">
        <nav class="sidebar-nav">
            <button class="sidebar-toggle" aria-label="Toggle sidebar">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            
            <ul class="sidebar-menu">
                <li class="menu-item active">
                    <a href="/admin/dashboard" class="menu-link" title="Dashboard">
                        <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                        <span class="menu-text">Dashboard</span>
                    </a>
                </li>
                
                <li class="menu-item">
                    <a href="/admin/tickets" class="menu-link" title="Tickets">
                        <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        <span class="menu-text">Tickets</span>
                    </a>
                </li>
                
                <li class="menu-item">
                    <a href="/admin/users" class="menu-link" title="Users">
                        <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <span class="menu-text">Users</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="dashboard-container">
            <h2 class="dashboard-title">Dashboard</h2>
            
            <!-- Ticket & User Section -->
            <div class="section-header">
                <span class="section-badge">Ticket & User</span>
            </div>
            <div class="stats-row">
                <!-- Total Tickets -->
                <div class="stat-card stat-card-blue">
                    <div class="stat-header">Total Tickets</div>
                    <div class="stat-value" id="totalTickets">0</div>
                </div>

                <!-- Open -->
                <div class="stat-card stat-card-gray">
                    <div class="stat-header">Open</div>
                    <div class="stat-value" id="totalOpen">0</div>
                </div>

                <!-- Assigned -->
                <div class="stat-card stat-card-orange">
                    <div class="stat-header">Assigned</div>
                    <div class="stat-value" id="totalAssigned">0</div>
                </div>

                <!-- In Progress -->
                <div class="stat-card stat-card-yellow">
                    <div class="stat-header">In Progress</div>
                    <div class="stat-value" id="totalInProgress">0</div>
                </div>

                <!-- Resolved -->
                <div class="stat-card stat-card-green">
                    <div class="stat-header">Resolved</div>
                    <div class="stat-value" id="totalResolved">0</div>
                </div>
            </div>

            <!-- Second Row -->
            <div class="stats-row stats-row-secondary">
                <!-- Closed -->
                <div class="stat-card stat-card-red">
                    <div class="stat-header">Closed</div>
                    <div class="stat-value" id="totalClosed">0</div>
                </div>

                <!-- Employees -->
                <div class="stat-card stat-card-cyan">
                    <div class="stat-value" id="totalEmployee">0</div>
                    <div class="stat-label">Employees</div>
                </div>

                <!-- IT Support -->
                <div class="stat-card stat-card-cyan">
                    <div class="stat-value" id="totalITSupport">0</div>
                    <div class="stat-label">IT Support</div>
                </div>
            </div>

            <!-- Ticket Category Section -->
            <div class="section-header">
                <span class="section-badge">Ticket Category</span>
            </div>
            <div class="stats-row" id="categoryStatsRow">
                <!-- Network -->
                <div class="stat-card stat-card-cyan-light">
                    <div class="stat-header">NETWORK</div>
                    <div class="stat-value" id="categoryNetwork">0</div>
                </div>

                <!-- Account -->
                <div class="stat-card stat-card-green-bright">
                    <div class="stat-header">ACCOUNT</div>
                    <div class="stat-value" id="categoryAccount">0</div>
                </div>

                <!-- Hardware -->
                <div class="stat-card stat-card-gray-dark">
                    <div class="stat-header">HARDWARE</div>
                    <div class="stat-value" id="categoryHardware">0</div>
                </div>

                <!-- Software -->
                <div class="stat-card stat-card-purple">
                    <div class="stat-header">SOFTWARE</div>
                    <div class="stat-value" id="categorySoftware">0</div>
                </div>
            </div>

            <!-- Ticket Priority Section -->
            <div class="section-header">
                <span class="section-badge">Ticket Priority</span>
            </div>
            <div class="stats-row">
                <!-- Low -->
                <div class="stat-card stat-card-green-priority">
                    <div class="stat-header">LOW</div>
                    <div class="stat-value" id="priorityLow">0</div>
                </div>

                <!-- Medium -->
                <div class="stat-card stat-card-orange-priority">
                    <div class="stat-header">MEDIUM</div>
                    <div class="stat-value" id="priorityMedium">0</div>
                </div>

                <!-- High -->
                <div class="stat-card stat-card-red-priority">
                    <div class="stat-header">HIGH</div>
                    <div class="stat-value" id="priorityHigh">0</div>
                </div>
            </div>
        </div>

        <!-- Refresh Button -->
        <button class="refresh-btn" id="refreshBtn" title="Refresh Data">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
            </svg>
        </button>

        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>
    </main>

    <script>
        // ========================================
        // API Configuration & Constants
        // ========================================
        const API_BASE_URL = 'http://localhost:8080/api';
        const TOKEN_KEY = 'auth_token';
        const USER_INFO_KEY = 'user_info';

        // ========================================
        // Authentication Manager
        // ========================================
        const AuthManager = {
            getToken() {
                return localStorage.getItem(TOKEN_KEY);
            },

            getUserInfo() {
                const userInfo = localStorage.getItem(USER_INFO_KEY);
                return userInfo ? JSON.parse(userInfo) : null;
            },

            isAuthenticated() {
                return !!this.getToken();
            },

            hasRole(role) {
                const userInfo = this.getUserInfo();
                return userInfo && userInfo.roles && userInfo.roles.includes(role);
            },

            logout() {
                localStorage.removeItem(TOKEN_KEY);
                localStorage.removeItem(USER_INFO_KEY);
                window.location.href = '/login';
            },

            requireAuth() {
                if (!this.isAuthenticated()) {
                    window.location.href = '/login';
                    return false;
                }
                return true;
            },

            isAdmin() {
                return this.hasRole('ROLE_ADMIN');
            }
        };

        // ========================================
        // API Client
        // ========================================
        const ApiClient = {
            async request(endpoint, options = {}) {
                const token = AuthManager.getToken();
                
                const config = {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...(token && { 'Authorization': `Bearer ${token}` }),
                        ...options.headers
                    }
                };

                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                    
                    if (response.status === 401) {
                        AuthManager.logout();
                        return null;
                    }

                    if (response.status === 403) {
                        console.error('Access denied - insufficient permissions');
                        return null;
                    }

                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || 'API request failed');
                    }

                    return data;
                } catch (error) {
                    console.error('API Error:', error);
                    throw error;
                }
            },

            async get(endpoint) {
                return this.request(endpoint, { method: 'GET' });
            }
        };

        // ========================================
        // Dashboard API Service
        // ========================================
        const DashboardAPI = {
            // Get ticket report (category, priority, status statistics)
            async getTicketReport() {
                try {
                    const response = await ApiClient.get('/reports/tickets');
                    return response && response.success ? response.data : null;
                } catch (error) {
                    console.error('Error fetching ticket report:', error);
                    return null;
                }
            },

            // Get user statistics
            async getUserStats() {
                try {
                    const response = await ApiClient.get('/users/stats');
                    return response && response.success ? response.data : null;
                } catch (error) {
                    console.error('Error fetching user stats:', error);
                    return null;
                }
            }
        };

        // ========================================
        // UI Manager
        // ========================================
        const UIManager = {
            updateUserGreeting() {
                const userInfo = AuthManager.getUserInfo();
                const greetingElement = document.getElementById('userGreeting');
                
                if (userInfo && greetingElement) {
                    const displayName = userInfo.fullName || userInfo.username;
                    greetingElement.textContent = `Welcome, ${displayName}`;
                }
            },

            updateStatValue(elementId, value, animate = true) {
                const element = document.getElementById(elementId);
                if (!element) return;
                
                if (animate) {
                    this.animateNumber(element, parseInt(element.textContent) || 0, value);
                } else {
                    element.textContent = value;
                }
            },

            animateNumber(element, start, end, duration = 500) {
                const startTime = performance.now();
                const diff = end - start;
                
                const animate = (currentTime) => {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    
                    // Easing function for smooth animation
                    const easeOutQuart = 1 - Math.pow(1 - progress, 4);
                    const current = Math.round(start + diff * easeOutQuart);
                    
                    element.textContent = current;
                    
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    }
                };
                
                requestAnimationFrame(animate);
            },

            // Update Ticket & User section
            updateTicketUserStats(report, userStats) {
                if (report) {
                    this.updateStatValue('totalTickets', report.totalTickets || 0);
                    
                    const statusMap = report.ticketsByStatus || {};
                    this.updateStatValue('totalOpen', statusMap['OPEN'] || 0);
                    this.updateStatValue('totalAssigned', statusMap['ASSIGNED'] || 0);
                    this.updateStatValue('totalInProgress', statusMap['IN_PROGRESS'] || 0);
                    this.updateStatValue('totalResolved', statusMap['RESOLVED'] || 0);
                    this.updateStatValue('totalClosed', statusMap['CLOSED'] || 0);
                }

                if (userStats) {
                    this.updateStatValue('totalEmployee', userStats.totalEmployees || 0);
                    this.updateStatValue('totalITSupport', userStats.totalITSupport || 0);
                }
            },

            // Update Ticket Category section
            updateCategoryStats(report) {
                if (!report || !report.ticketsByCategory) return;
                
                const categoryMap = report.ticketsByCategory;
                this.updateStatValue('categoryNetwork', categoryMap['NETWORK'] || 0);
                this.updateStatValue('categoryAccount', categoryMap['ACCOUNT'] || 0);
                this.updateStatValue('categoryHardware', categoryMap['HARDWARE'] || 0);
                this.updateStatValue('categorySoftware', categoryMap['SOFTWARE'] || 0);
            },

            // Update Ticket Priority section
            updatePriorityStats(report) {
                if (!report || !report.ticketsByPriority) return;
                
                const priorityMap = report.ticketsByPriority;
                this.updateStatValue('priorityLow', priorityMap['LOW'] || 0);
                this.updateStatValue('priorityMedium', priorityMap['MEDIUM'] || 0);
                this.updateStatValue('priorityHigh', priorityMap['HIGH'] || 0);
            },

            showLoading() {
                document.getElementById('loadingOverlay').style.display = 'flex';
            },

            hideLoading() {
                document.getElementById('loadingOverlay').style.display = 'none';
            },

            showError(message) {
                console.error(message);
                this.showToast(message, 'error');
            },

            showSuccess(message) {
                this.showToast(message, 'success');
            },

            showToast(message, type = 'info') {
                const container = document.getElementById('toastContainer');
                if (!container) return;

                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        ${type === 'success' 
                            ? '<polyline points="20 6 9 17 4 12"></polyline>'
                            : type === 'error'
                            ? '<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>'
                            : '<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line>'
                        }
                    </svg>
                    <span>${message}</span>
                `;
                
                container.appendChild(toast);

                // Auto remove after 3 seconds
                setTimeout(() => {
                    toast.style.animation = 'slideInRight 0.3s ease reverse';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            }
        };

        // ========================================
        // Dashboard Controller
        // ========================================
        const DashboardController = {
            async init() {
                // Check authentication
                if (!AuthManager.requireAuth()) return;
                
                // Check admin role
                if (!AuthManager.isAdmin()) {
                    window.location.href = '/login';
                    return;
                }

                // Setup UI
                this.setupEventListeners();
                UIManager.updateUserGreeting();
                
                // Load dashboard data
                await this.loadDashboardData();
            },

            setupEventListeners() {
                // Toggle sidebar
                const sidebar = document.querySelector('.sidebar');
                const toggleBtn = document.querySelector('.sidebar-toggle');
                const mainContent = document.querySelector('.main-content');
                
                toggleBtn?.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('sidebar-collapsed');
                });

                // Logout button
                document.querySelector('.btn-logout')?.addEventListener('click', () => {
                    if (confirm('Are you sure you want to logout?')) {
                        AuthManager.logout();
                    }
                });

                // User profile button
                document.querySelector('.btn-user')?.addEventListener('click', () => {
                    window.location.href = '/profile';
                });

                // Refresh button
                const refreshBtn = document.getElementById('refreshBtn');
                refreshBtn?.addEventListener('click', async () => {
                    refreshBtn.classList.add('spinning');
                    await this.refresh();
                    refreshBtn.classList.remove('spinning');
                    UIManager.showSuccess('Dashboard refreshed successfully!');
                });
            },

            async loadDashboardData() {
                UIManager.showLoading();
                
                try {
                    // Fetch all data in parallel
                    const [ticketReport, userStats] = await Promise.all([
                        DashboardAPI.getTicketReport(),
                        DashboardAPI.getUserStats()
                    ]);

                    // Update UI with fetched data
                    UIManager.updateTicketUserStats(ticketReport, userStats);
                    UIManager.updateCategoryStats(ticketReport);
                    UIManager.updatePriorityStats(ticketReport);

                    console.log('Dashboard data loaded successfully');
                } catch (error) {
                    UIManager.showError('Failed to load dashboard data');
                    console.error('Dashboard load error:', error);
                } finally {
                    UIManager.hideLoading();
                }
            },

            async refresh() {
                await this.loadDashboardData();
            }
        };

        // ========================================
        // Initialize Dashboard on DOM Ready
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            DashboardController.init();
        });
    </script>
</body>
</html>