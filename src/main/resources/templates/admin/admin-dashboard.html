<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Helpdesk - Admin Dashboard</title>
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/admin/admin-sidebar.css">
    <link rel="stylesheet" href="/css/admin/admin-dashboard.css">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <p>Loading dashboard...</p>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1 class="header-title">IT Helpdesk</h1>
            <div class="header-actions">
                <span id="userGreeting" class="user-greeting"></span>
                <button class="btn-icon btn-user" aria-label="User profile" title="User Profile">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </button>
                <button class="btn-icon btn-logout" aria-label="Logout" title="Logout">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <aside class="sidebar">
        <nav class="sidebar-nav">
            <button class="sidebar-toggle" aria-label="Toggle sidebar">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            
            <ul class="sidebar-menu">
                <li class="menu-item active">
                    <a href="/admin/dashboard" class="menu-link" title="Dashboard">
                        <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                        <span class="menu-text">Dashboard</span>
                    </a>
                </li>
                
                <li class="menu-item">
                    <a href="/admin/tickets" class="menu-link" title="Tickets">
                        <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        <span class="menu-text">Tickets</span>
                    </a>
                </li>
                
                <li class="menu-item">
                    <a href="/admin/users" class="menu-link" title="Users">
                        <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <span class="menu-text">Users</span>
                    </a>
                </li>
                
                <li class="menu-item">
                    <a href="/admin/reports" class="menu-link" title="Reports">
                        <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                        <span class="menu-text">Reports</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="dashboard-container">
            <h2 class="dashboard-title">Admin Dashboard</h2>
            
            <!-- Statistics Cards Grid -->
            <div class="stats-grid">
                <!-- Total Tickets -->
                <div class="stat-card stat-card-primary">
                    <div class="stat-header">Total Tickets</div>
                    <div class="stat-value" id="totalTickets">
                        <span class="loading-placeholder">--</span>
                    </div>
                </div>

                <!-- Total Open -->
                <div class="stat-card stat-card-secondary">
                    <div class="stat-header">Open</div>
                    <div class="stat-value" id="totalOpen">
                        <span class="loading-placeholder">--</span>
                    </div>
                </div>

                <!-- Total Assigned -->
                <div class="stat-card stat-card-warning">
                    <div class="stat-header">Assigned</div>
                    <div class="stat-value" id="totalAssigned">
                        <span class="loading-placeholder">--</span>
                    </div>
                </div>

                <!-- Total In Progress -->
                <div class="stat-card stat-card-yellow">
                    <div class="stat-header">In Progress</div>
                    <div class="stat-value" id="totalInProgress">
                        <span class="loading-placeholder">--</span>
                    </div>
                </div>

                <!-- Total Resolved -->
                <div class="stat-card stat-card-success">
                    <div class="stat-header">Resolved</div>
                    <div class="stat-value" id="totalResolved">
                        <span class="loading-placeholder">--</span>
                    </div>
                </div>

                <!-- Total Closed -->
                <div class="stat-card stat-card-danger">
                    <div class="stat-header">Closed</div>
                    <div class="stat-value" id="totalClosed">
                        <span class="loading-placeholder">--</span>
                    </div>
                </div>

                <!-- Employee Count -->
                <div class="stat-card stat-card-info">
                    <div class="stat-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                        </svg>
                    </div>
                    <div class="stat-value" id="totalEmployee">
                        <span class="loading-placeholder">--</span>
                    </div>
                    <div class="stat-label">Employees</div>
                </div>

                <!-- IT Support Count -->
                <div class="stat-card stat-card-info">
                    <div class="stat-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 1c-4.97 0-9 4.03-9 9v7c0 1.66 1.34 3 3 3h3v-8H5v-2c0-3.87 3.13-7 7-7s7 3.13 7 7v2h-4v8h3c1.66 0 3-1.34 3-3v-7c0-4.97-4.03-9-9-9z"/>
                        </svg>
                    </div>
                    <div class="stat-value" id="totalITSupport">
                        <span class="loading-placeholder">--</span>
                    </div>
                    <div class="stat-label">IT Support</div>
                </div>
            </div>

            <!-- Last Updated Info -->
            <div class="last-updated" id="lastUpdated"></div>
        </div>
    </main>

    <script>
        /**
         * Admin Dashboard Module
         * Handles dashboard data fetching and display
         */
        (function() {
            'use strict';

            // ==========================================
            // Configuration
            // ==========================================
            const CONFIG = {
                API_BASE_URL: '/api',
                ENDPOINTS: {
                    TICKETS: '/tickets',
                    USERS: '/users'
                },
                STORAGE_KEYS: {
                    TOKEN: 'auth_token',
                    TOKEN_TYPE: 'token_type',
                    USER: 'user_info'
                },
                LOGIN_URL: '/login',
                REQUIRED_ROLE: 'ROLE_ADMIN',
                REFRESH_INTERVAL: 60000 // Refresh data every 60 seconds
            };

            // Ticket Status Enum (matching backend)
            const TICKET_STATUS = {
                OPEN: 'OPEN',
                ASSIGNED: 'ASSIGNED',
                IN_PROGRESS: 'IN_PROGRESS',
                RESOLVED: 'RESOLVED',
                CLOSED: 'CLOSED'
            };

            // User Roles
            const USER_ROLES = {
                ADMIN: 'ROLE_ADMIN',
                IT_SUPPORT: 'ROLE_IT_SUPPORT',
                EMPLOYEE: 'ROLE_EMPLOYEE'
            };

            // ==========================================
            // DOM Elements
            // ==========================================
            const elements = {
                loadingOverlay: document.getElementById('loadingOverlay'),
                userGreeting: document.getElementById('userGreeting'),
                totalTickets: document.getElementById('totalTickets'),
                totalOpen: document.getElementById('totalOpen'),
                totalAssigned: document.getElementById('totalAssigned'),
                totalInProgress: document.getElementById('totalInProgress'),
                totalResolved: document.getElementById('totalResolved'),
                totalClosed: document.getElementById('totalClosed'),
                totalEmployee: document.getElementById('totalEmployee'),
                totalITSupport: document.getElementById('totalITSupport'),
                lastUpdated: document.getElementById('lastUpdated'),
                sidebar: document.querySelector('.sidebar'),
                toggleBtn: document.querySelector('.sidebar-toggle'),
                mainContent: document.querySelector('.main-content')
            };

            // ==========================================
            // Authentication Functions
            // ==========================================

            /**
             * Get authentication token from localStorage
             */
            function getAuthToken() {
                return localStorage.getItem(CONFIG.STORAGE_KEYS.TOKEN);
            }

            /**
             * Get token type from localStorage
             */
            function getTokenType() {
                return localStorage.getItem(CONFIG.STORAGE_KEYS.TOKEN_TYPE) || 'Bearer';
            }

            /**
             * Get user info from localStorage
             */
            function getUserInfo() {
                const userStr = localStorage.getItem(CONFIG.STORAGE_KEYS.USER);
                try {
                    return userStr ? JSON.parse(userStr) : null;
                } catch (e) {
                    console.error('Error parsing user info:', e);
                    return null;
                }
            }

            /**
             * Check if user is authenticated
             */
            function isAuthenticated() {
                const token = getAuthToken();
                if (!token) return false;

                try {
                    const parts = token.split('.');
                    if (parts.length !== 3) return false;

                    const payload = JSON.parse(atob(parts[1]));
                    const expiration = payload.exp * 1000;

                    return Date.now() < expiration;
                } catch (error) {
                    console.error('Error checking authentication:', error);
                    return false;
                }
            }

            /**
             * Check if user has admin role
             */
            function hasAdminRole() {
                const userInfo = getUserInfo();
                if (!userInfo || !userInfo.roles) return false;

                const roles = Array.isArray(userInfo.roles) ? userInfo.roles : [];
                return roles.includes(CONFIG.REQUIRED_ROLE);
            }

            /**
             * Clear authentication data and redirect to login
             */
            function logout() {
                localStorage.removeItem(CONFIG.STORAGE_KEYS.TOKEN);
                localStorage.removeItem(CONFIG.STORAGE_KEYS.TOKEN_TYPE);
                localStorage.removeItem(CONFIG.STORAGE_KEYS.USER);
                window.location.href = CONFIG.LOGIN_URL;
            }

            /**
             * Verify access and redirect if unauthorized
             */
            function verifyAccess() {
                if (!isAuthenticated()) {
                    console.log('Not authenticated, redirecting to login...');
                    window.location.href = CONFIG.LOGIN_URL;
                    return false;
                }

                if (!hasAdminRole()) {
                    console.log('User does not have admin role, access denied');
                    alert('Access Denied! You do not have permission to access the Admin Dashboard.');
                    logout();
                    return false;
                }

                return true;
            }

            // ==========================================
            // API Functions
            // ==========================================

            /**
             * Get authorization headers for API calls
             */
            function getAuthHeaders() {
                return {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'Authorization': `${getTokenType()} ${getAuthToken()}`
                };
            }

            /**
             * Fetch all tickets from API
             */
            async function fetchAllTickets() {
                const url = `${CONFIG.API_BASE_URL}${CONFIG.ENDPOINTS.TICKETS}`;

                const response = await fetch(url, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                if (response.status === 401 || response.status === 403) {
                    logout();
                    throw new Error('Unauthorized');
                }

                if (!response.ok) {
                    throw new Error(`Failed to fetch tickets: ${response.status}`);
                }

                const data = await response.json();
                return data.success ? data.data : [];
            }

            /**
             * Fetch all users from API
             */
            async function fetchAllUsers() {
                const url = `${CONFIG.API_BASE_URL}${CONFIG.ENDPOINTS.USERS}`;

                const response = await fetch(url, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                if (response.status === 401 || response.status === 403) {
                    logout();
                    throw new Error('Unauthorized');
                }

                if (!response.ok) {
                    throw new Error(`Failed to fetch users: ${response.status}`);
                }

                const data = await response.json();
                return data.success ? data.data : [];
            }

            // ==========================================
            // Data Processing Functions
            // ==========================================

            /**
             * Count tickets by status
             */
            function countTicketsByStatus(tickets) {
                const counts = {
                    total: tickets.length,
                    [TICKET_STATUS.OPEN]: 0,
                    [TICKET_STATUS.ASSIGNED]: 0,
                    [TICKET_STATUS.IN_PROGRESS]: 0,
                    [TICKET_STATUS.RESOLVED]: 0,
                    [TICKET_STATUS.CLOSED]: 0
                };

                tickets.forEach(ticket => {
                    if (ticket.status && counts.hasOwnProperty(ticket.status)) {
                        counts[ticket.status]++;
                    }
                });

                return counts;
            }

            /**
             * Count users by role
             */
            function countUsersByRole(users) {
                const counts = {
                    [USER_ROLES.IT_SUPPORT]: 0,
                    [USER_ROLES.EMPLOYEE]: 0,
                    [USER_ROLES.ADMIN]: 0
                };

                users.forEach(user => {
                    if (user.roles && Array.isArray(user.roles)) {
                        user.roles.forEach(role => {
                            if (counts.hasOwnProperty(role)) {
                                counts[role]++;
                            }
                        });
                    }
                });

                return counts;
            }

            // ==========================================
            // UI Update Functions
            // ==========================================

            /**
             * Update stat card value with animation
             */
            function updateStatValue(element, value) {
                if (!element) return;

                // Add animation class
                element.classList.add('updating');

                // Update value
                element.textContent = value;

                // Remove animation class after animation completes
                setTimeout(() => {
                    element.classList.remove('updating');
                }, 300);
            }

            /**
             * Update ticket statistics UI
             */
            function updateTicketStats(ticketCounts) {
                updateStatValue(elements.totalTickets, ticketCounts.total);
                updateStatValue(elements.totalOpen, ticketCounts[TICKET_STATUS.OPEN]);
                updateStatValue(elements.totalAssigned, ticketCounts[TICKET_STATUS.ASSIGNED]);
                updateStatValue(elements.totalInProgress, ticketCounts[TICKET_STATUS.IN_PROGRESS]);
                updateStatValue(elements.totalResolved, ticketCounts[TICKET_STATUS.RESOLVED]);
                updateStatValue(elements.totalClosed, ticketCounts[TICKET_STATUS.CLOSED]);
            }

            /**
             * Update user statistics UI
             */
            function updateUserStats(userCounts) {
                updateStatValue(elements.totalEmployee, userCounts[USER_ROLES.EMPLOYEE]);
                updateStatValue(elements.totalITSupport, userCounts[USER_ROLES.IT_SUPPORT]);
            }

            /**
             * Update last updated timestamp
             */
            function updateLastUpdatedTime() {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('vi-VN', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                const dateStr = now.toLocaleDateString('vi-VN');
                
                if (elements.lastUpdated) {
                    elements.lastUpdated.innerHTML = `<span>Last updated: ${dateStr} ${timeStr}</span>
                        <button id="refreshBtn" class="refresh-btn" title="Refresh Data">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="23 4 23 10 17 10"></polyline>
                                <polyline points="1 20 1 14 7 14"></polyline>
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                            </svg>
                        </button>`;
                    
                    // Add click handler for refresh button
                    document.getElementById('refreshBtn')?.addEventListener('click', loadDashboardData);
                }
            }

            /**
             * Display user greeting
             */
            function displayUserGreeting() {
                const userInfo = getUserInfo();
                if (userInfo && elements.userGreeting) {
                    const name = userInfo.fullName || userInfo.username || 'Admin';
                    elements.userGreeting.textContent = `Welcome, ${name}`;
                }
            }

            /**
             * Show/hide loading overlay
             */
            function setLoading(isLoading) {
                if (elements.loadingOverlay) {
                    elements.loadingOverlay.style.display = isLoading ? 'flex' : 'none';
                }
            }

            /**
             * Show error state in stat card
             */
            function showErrorState(element, message = 'Error') {
                if (element) {
                    element.innerHTML = `<span class="error-text">${message}</span>`;
                }
            }

            // ==========================================
            // Main Data Loading Function
            // ==========================================

            /**
             * Load all dashboard data
             */
            async function loadDashboardData() {
                try {
                    setLoading(true);

                    // Fetch data in parallel
                    const [tickets, users] = await Promise.all([
                        fetchAllTickets(),
                        fetchAllUsers()
                    ]);

                    // Process data
                    const ticketCounts = countTicketsByStatus(tickets);
                    const userCounts = countUsersByRole(users);

                    // Update UI
                    updateTicketStats(ticketCounts);
                    updateUserStats(userCounts);
                    updateLastUpdatedTime();

                    console.log('Dashboard data loaded successfully:', {
                        tickets: ticketCounts,
                        users: userCounts
                    });

                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    
                    // Show error state in all stat cards
                    showErrorState(elements.totalTickets, '--');
                    showErrorState(elements.totalOpen, '--');
                    showErrorState(elements.totalAssigned, '--');
                    showErrorState(elements.totalInProgress, '--');
                    showErrorState(elements.totalResolved, '--');
                    showErrorState(elements.totalClosed, '--');
                    showErrorState(elements.totalEmployee, '--');
                    showErrorState(elements.totalITSupport, '--');

                    if (elements.lastUpdated) {
                        elements.lastUpdated.innerHTML = '<span class="error-text">Failed to load data. Click to retry.</span>';
                        elements.lastUpdated.style.cursor = 'pointer';
                        elements.lastUpdated.addEventListener('click', loadDashboardData, { once: true });
                    }
                } finally {
                    setLoading(false);
                }
            }

            // ==========================================
            // Event Handlers
            // ==========================================

            /**
             * Initialize sidebar toggle
             */
            function initSidebar() {
                if (elements.toggleBtn && elements.sidebar && elements.mainContent) {
                    elements.toggleBtn.addEventListener('click', () => {
                        elements.sidebar.classList.toggle('collapsed');
                        elements.mainContent.classList.toggle('sidebar-collapsed');
                    });
                }

                // Active menu item handling
                const menuLinks = document.querySelectorAll('.menu-link');
                menuLinks.forEach(link => {
                    link.addEventListener('click', (e) => {
                        document.querySelector('.menu-item.active')?.classList.remove('active');
                        link.parentElement.classList.add('active');
                    });
                });
            }

            /**
             * Initialize header buttons
             */
            function initHeaderButtons() {
                // User profile button
                document.querySelector('.btn-user')?.addEventListener('click', () => {
                    const userInfo = getUserInfo();
                    if (userInfo) {
                        alert(`User Profile\n\nUsername: ${userInfo.username}\nFull Name: ${userInfo.fullName || 'N/A'}\nEmail: ${userInfo.email || 'N/A'}\nRoles: ${userInfo.roles?.join(', ') || 'N/A'}`);
                    }
                });

                // Logout button
                document.querySelector('.btn-logout')?.addEventListener('click', () => {
                    if (confirm('Are you sure you want to logout?')) {
                        logout();
                    }
                });
            }

            // ==========================================
            // Initialization
            // ==========================================

            /**
             * Initialize dashboard
             */
            function init() {
                // Verify access first
                if (!verifyAccess()) {
                    return;
                }

                // Display user greeting
                displayUserGreeting();

                // Initialize UI components
                initSidebar();
                initHeaderButtons();

                // Load dashboard data
                loadDashboardData();

                // Set up auto-refresh
                setInterval(loadDashboardData, CONFIG.REFRESH_INTERVAL);
            }

            // Run initialization when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</body>
</html>
