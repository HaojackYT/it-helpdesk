<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Helpdesk - Users Management</title>
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/admin/admin-sidebar.css">
    <link rel="stylesheet" href="/css/admin/admin-user.css">
    <link rel="stylesheet" href="/css/component/edit-user.css">
    <link rel="stylesheet" href="/css/component/delete-user.css">
    <link rel="stylesheet" href="/css/component/user-profile.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1 class="header-title">IT Helpdesk</h1>
            <div class="header-actions">
                <span class="user-info" id="currentUserInfo"></span>
                <button class="btn-icon btn-user" aria-label="User profile" id="btnUserProfile">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </button>
                <button class="btn-icon btn-logout" aria-label="Logout" id="btnLogout">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <aside class="sidebar">
        <nav class="sidebar-nav">
            <button class="sidebar-toggle" aria-label="Toggle sidebar">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            
            <ul class="sidebar-menu">
                <li class="menu-item">
                    <a href="/admin/dashboard" class="menu-link" title="Dashboard">
                        <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                        <span class="menu-text">Dashboard</span>
                    </a>
                </li>
                
                <li class="menu-item">
                    <a href="/admin/tickets" class="menu-link" title="Tickets">
                        <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        <span class="menu-text">Tickets</span>
                    </a>
                </li>
                
                <li class="menu-item active">
                    <a href="/admin/users" class="menu-link" title="Users">
                        <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <span class="menu-text">Users</span>
                    </a>
                </li>
                
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="users-container">
            <!-- Page Header -->
            <div class="page-header">
                <h2 class="page-title">Users</h2>
            </div>

            <!-- Controls Section -->
            <div class="users-controls">
                <div class="search-wrapper">
                    <input 
                        type="text" 
                        class="search-input" 
                        placeholder="Find user"
                        id="searchInput"
                    >
                    <button class="search-btn" aria-label="Search">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </button>
                </div>

                <div class="entries-control">
                    <label class="entries-label">Show:</label>
                    <select class="entries-select" id="entriesSelect">
                        <option value="10" selected>10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span class="entries-label">Entries</span>
                </div>
            </div>

            <!-- Loading State -->
            <div class="loading-state" id="loadingState">
                <div class="spinner"></div>
                <p>Loading users...</p>
            </div>

            <!-- Error State -->
            <div class="error-state" id="errorState" style="display: none;">
                <p id="errorMessage">Failed to load users</p>
                <button class="retry-btn" id="retryBtn">Retry</button>
            </div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                <p>No users found</p>
            </div>

            <!-- Table Wrapper -->
            <div class="table-wrapper" id="tableWrapper" style="display: none;">
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Username</th>
                            <th>Full Name</th>
                            <th>Email</th>
                            <th>Department</th>
                            <th>Status</th>
                            <th>Created At</th>
                            <th>Roles</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Dynamic content will be inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination-wrapper" id="paginationWrapper" style="display: none;">
                <div class="pagination-info" id="paginationInfo">
                    Showing 0 to 0 of 0 entries
                </div>
                <div class="pagination-controls" id="paginationControls">
                    <!-- Dynamic pagination buttons -->
                </div>
            </div>
        </div>
    </main>

    <!-- Edit User Modal -->
    <div class="modal-overlay" id="editUserModal" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Edit User</h2>
                <button class="modal-close" id="closeEditModal" aria-label="Close modal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form class="edit-user-form" id="editUserForm">
                    <input type="hidden" id="editUserId">
                    <div class="form-group">
                        <label class="form-label" for="editFullName">Full Name</label>
                        <input type="text" class="form-input" id="editFullName" placeholder="Enter full name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="editPassword">New Password (leave blank to keep current)</label>
                        <input type="password" class="form-input" id="editPassword" placeholder="Enter new password">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="editEmail">Email</label>
                        <input type="email" class="form-input" id="editEmail" placeholder="Enter email" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="editDepartment">Department</label>
                        <input type="text" class="form-input" id="editDepartment" placeholder="Enter department">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="editStatus">Status</label>
                        <select class="form-input" id="editStatus">
                            <option value="ACTIVE">Active</option>
                            <option value="LOCKED">Locked</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Roles</label>
                        <div class="role-buttons">
                            <button type="button" class="role-btn" data-role="ADMIN">ADMIN</button>
                            <button type="button" class="role-btn" data-role="IT_SUPPORT">IT SUPPORT</button>
                            <button type="button" class="role-btn" data-role="EMPLOYEE">EMPLOYEE</button>
                        </div>
                    </div>
                    <button type="submit" class="btn-submit" id="btnUpdateUser">Update User</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete User Modal -->
    <div class="modal-overlay" id="deleteUserModal" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Delete User</h2>
                <button class="modal-close" id="closeDeleteModal" aria-label="Close modal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="deleteUserIdHidden">
                <div class="user-info-grid">
                    <div class="info-row">
                        <span class="info-label">ID</span>
                        <span class="info-value" id="deleteUserId">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Username</span>
                        <span class="info-value" id="deleteUsername">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Full Name</span>
                        <span class="info-value" id="deleteFullName">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Email</span>
                        <span class="info-value" id="deleteEmail">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Department</span>
                        <span class="info-value" id="deleteDepartment">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Status</span>
                        <span class="info-value" id="deleteStatus">-</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Created At</span>
                        <span class="info-value" id="deleteCreatedAt">-</span>
                    </div>
                    <div class="info-row roles-row">
                        <span class="info-label">Roles</span>
                        <div class="role-badges" id="deleteRoles"></div>
                    </div>
                </div>
                <div class="warning-message">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>
                    <p>Are you sure you want to delete this user? This action cannot be undone.</p>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" id="btnCancelDelete">Cancel</button>
                    <button type="button" class="btn-delete" id="btnConfirmDelete">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // =============================================
        // CONFIGURATION & CONSTANTS
        // =============================================
        const API_BASE_URL = '/api';
        const TOKEN_KEY = 'auth_token';
        const USER_INFO_KEY = 'user_info';

        // =============================================
        // AUTHENTICATION UTILITIES (using sessionStorage for tab isolation)
        // =============================================
        const AuthService = {
            getToken() {
                return sessionStorage.getItem(TOKEN_KEY);
            },

            setToken(token) {
                sessionStorage.setItem(TOKEN_KEY, token);
            },

            removeToken() {
                sessionStorage.removeItem(TOKEN_KEY);
                sessionStorage.removeItem(USER_INFO_KEY);
                sessionStorage.removeItem('token_type');
            },

            getUserInfo() {
                const info = sessionStorage.getItem(USER_INFO_KEY);
                return info ? JSON.parse(info) : null;
            },

            setUserInfo(info) {
                sessionStorage.setItem(USER_INFO_KEY, JSON.stringify(info));
            },

            isAuthenticated() {
                const token = this.getToken();
                if (!token) return false;
                
                // Check if token is expired (basic check)
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    return payload.exp * 1000 > Date.now();
                } catch (e) {
                    return false;
                }
            },

            hasRole(role) {
                const userInfo = this.getUserInfo();
                return userInfo && userInfo.roles && userInfo.roles.includes(role);
            },

            redirectToLogin() {
                window.location.href = '/login';
            }
        };

        // =============================================
        // API SERVICE
        // =============================================
        const ApiService = {
            async request(endpoint, options = {}) {
                const token = AuthService.getToken();
                
                if (!token) {
                    AuthService.redirectToLogin();
                    throw new Error('No authentication token');
                }

                const config = {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`,
                        ...options.headers
                    }
                };

                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                    
                    if (response.status === 401 || response.status === 403) {
                        AuthService.removeToken();
                        AuthService.redirectToLogin();
                        throw new Error('Unauthorized access');
                    }

                    const data = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(data.message || 'API request failed');
                    }

                    return data;
                } catch (error) {
                    console.error('API Error:', error);
                    throw error;
                }
            },

            // User API methods
            async getAllUsers() {
                return this.request('/users');
            },

            async getUserById(id) {
                return this.request(`/users/${id}`);
            },

            async updateUser(id, userData) {
                return this.request(`/users/${id}`, {
                    method: 'PUT',
                    body: JSON.stringify(userData)
                });
            },

            async deleteUser(id) {
                return this.request(`/users/${id}`, {
                    method: 'DELETE'
                });
            },

            async assignRoles(id, roles) {
                return this.request(`/users/${id}/roles`, {
                    method: 'POST',
                    body: JSON.stringify({ roleNames: roles })
                });
            }
        };

        // =============================================
        // UI UTILITIES
        // =============================================
        const UIUtils = {
            showToast(message, type = 'success') {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.innerHTML = `
                    <span class="toast-message">${message}</span>
                    <button class="toast-close">&times;</button>
                `;
                
                container.appendChild(toast);
                
                // Auto remove after 5 seconds
                setTimeout(() => {
                    toast.classList.add('toast-fade-out');
                    setTimeout(() => toast.remove(), 300);
                }, 5000);

                // Manual close
                toast.querySelector('.toast-close').addEventListener('click', () => {
                    toast.remove();
                });
            },

            formatDate(dateString) {
                if (!dateString) return '-';
                const date = new Date(dateString);
                return date.toLocaleString('vi-VN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            },

            formatId(uuid) {
                if (!uuid) return '-';
                return uuid.substring(0, 8) + '...';
            },

            getStatusClass(status) {
                const statusMap = {
                    'ACTIVE': 'status-active',
                    'LOCKED': 'status-locked',
                    'INACTIVE': 'status-inactive'
                };
                return statusMap[status] || 'status-inactive';
            },

            formatRoles(roles) {
                if (!roles || roles.length === 0) return '-';
                return Array.from(roles).map(role => 
                    role.replace('ROLE_', '').replace('_', ' ')
                ).join(', ');
            }
        };

        // =============================================
        // STATE MANAGEMENT
        // =============================================
        let allUsers = [];
        let filteredUsers = [];
        let currentPage = 1;
        let entriesPerPage = 10;
        let currentEditUserId = null;
        let currentDeleteUserId = null;

        // =============================================
        // DOM ELEMENTS
        // =============================================
        const elements = {
            // States
            loadingState: document.getElementById('loadingState'),
            errorState: document.getElementById('errorState'),
            emptyState: document.getElementById('emptyState'),
            tableWrapper: document.getElementById('tableWrapper'),
            paginationWrapper: document.getElementById('paginationWrapper'),
            
            // Table
            usersTableBody: document.getElementById('usersTableBody'),
            
            // Controls
            searchInput: document.getElementById('searchInput'),
            entriesSelect: document.getElementById('entriesSelect'),
            retryBtn: document.getElementById('retryBtn'),
            
            // Pagination
            paginationInfo: document.getElementById('paginationInfo'),
            paginationControls: document.getElementById('paginationControls'),
            
            // Edit Modal
            editModal: document.getElementById('editUserModal'),
            closeEditModal: document.getElementById('closeEditModal'),
            editForm: document.getElementById('editUserForm'),
            editUserId: document.getElementById('editUserId'),
            editFullName: document.getElementById('editFullName'),
            editPassword: document.getElementById('editPassword'),
            editEmail: document.getElementById('editEmail'),
            editDepartment: document.getElementById('editDepartment'),
            editStatus: document.getElementById('editStatus'),
            btnUpdateUser: document.getElementById('btnUpdateUser'),
            
            // Delete Modal
            deleteModal: document.getElementById('deleteUserModal'),
            closeDeleteModal: document.getElementById('closeDeleteModal'),
            deleteUserIdHidden: document.getElementById('deleteUserIdHidden'),
            deleteUserId: document.getElementById('deleteUserId'),
            deleteUsername: document.getElementById('deleteUsername'),
            deleteFullName: document.getElementById('deleteFullName'),
            deleteEmail: document.getElementById('deleteEmail'),
            deleteDepartment: document.getElementById('deleteDepartment'),
            deleteStatus: document.getElementById('deleteStatus'),
            deleteCreatedAt: document.getElementById('deleteCreatedAt'),
            deleteRoles: document.getElementById('deleteRoles'),
            btnCancelDelete: document.getElementById('btnCancelDelete'),
            btnConfirmDelete: document.getElementById('btnConfirmDelete'),
            
            // Header
            currentUserInfo: document.getElementById('currentUserInfo'),
            btnLogout: document.getElementById('btnLogout'),
            
            // Sidebar
            sidebar: document.querySelector('.sidebar'),
            sidebarToggle: document.querySelector('.sidebar-toggle'),
            mainContent: document.querySelector('.main-content')
        };

        // =============================================
        // RENDER FUNCTIONS
        // =============================================
        function showState(state) {
            elements.loadingState.style.display = 'none';
            elements.errorState.style.display = 'none';
            elements.emptyState.style.display = 'none';
            elements.tableWrapper.style.display = 'none';
            elements.paginationWrapper.style.display = 'none';

            switch(state) {
                case 'loading':
                    elements.loadingState.style.display = 'flex';
                    break;
                case 'error':
                    elements.errorState.style.display = 'flex';
                    break;
                case 'empty':
                    elements.emptyState.style.display = 'flex';
                    break;
                case 'data':
                    elements.tableWrapper.style.display = 'block';
                    elements.paginationWrapper.style.display = 'flex';
                    break;
            }
        }

        function renderUsersTable() {
            const startIndex = (currentPage - 1) * entriesPerPage;
            const endIndex = startIndex + entriesPerPage;
            const usersToShow = filteredUsers.slice(startIndex, endIndex);

            if (usersToShow.length === 0) {
                showState('empty');
                return;
            }

            elements.usersTableBody.innerHTML = usersToShow.map(user => `
                <tr data-user-id="${user.id}">
                    <td class="td-id" title="${user.id}">${UIUtils.formatId(user.id)}</td>
                    <td class="td-username">${user.username || '-'}</td>
                    <td class="td-fullname">${user.fullName || '-'}</td>
                    <td class="td-email">${user.email || '-'}</td>
                    <td class="td-department">${user.department || '-'}</td>
                    <td>
                        <span class="status-badge ${UIUtils.getStatusClass(user.status)}">
                            ${user.status || 'UNKNOWN'}
                        </span>
                    </td>
                    <td class="td-created">${UIUtils.formatDate(user.createdAt)}</td>
                    <td class="td-role">${UIUtils.formatRoles(user.roles)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn btn-edit" title="Edit user" data-user-id="${user.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                            <button class="action-btn action-btn-delete btn-delete-user" title="Delete user" data-user-id="${user.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');

            // Attach event listeners to action buttons
            attachActionButtonListeners();
            
            showState('data');
            renderPagination();
        }

        function renderPagination() {
            const totalPages = Math.ceil(filteredUsers.length / entriesPerPage);
            const startItem = (currentPage - 1) * entriesPerPage + 1;
            const endItem = Math.min(currentPage * entriesPerPage, filteredUsers.length);

            elements.paginationInfo.textContent = 
                `Showing ${startItem} to ${endItem} of ${filteredUsers.length} entries`;

            let paginationHTML = `
                <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} data-page="first" aria-label="First page">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="11 17 6 12 11 7"></polyline>
                        <polyline points="18 17 13 12 18 7"></polyline>
                    </svg>
                </button>
                <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} data-page="prev" aria-label="Previous page">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="15 18 9 12 15 6"></polyline>
                    </svg>
                </button>
            `;

            // Page numbers
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button class="pagination-btn ${i === currentPage ? 'active' : ''}" data-page="${i}">
                        <span class="pagination-number">${i}</span>
                    </button>
                `;
            }

            paginationHTML += `
                <button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} data-page="next" aria-label="Next page">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="9 18 15 12 9 6"></polyline>
                    </svg>
                </button>
                <button class="pagination-btn" ${currentPage === totalPages ? 'disabled' : ''} data-page="last" aria-label="Last page">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="13 17 18 12 13 7"></polyline>
                        <polyline points="6 17 11 12 6 7"></polyline>
                    </svg>
                </button>
            `;

            elements.paginationControls.innerHTML = paginationHTML;

            // Attach pagination event listeners
            elements.paginationControls.querySelectorAll('.pagination-btn').forEach(btn => {
                btn.addEventListener('click', handlePaginationClick);
            });
        }

        // =============================================
        // EVENT HANDLERS
        // =============================================
        function attachActionButtonListeners() {
            // Edit buttons
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const userId = e.currentTarget.dataset.userId;
                    openEditModal(userId);
                });
            });

            // Delete buttons
            document.querySelectorAll('.btn-delete-user').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const userId = e.currentTarget.dataset.userId;
                    openDeleteModal(userId);
                });
            });
        }

        function handlePaginationClick(e) {
            const page = e.currentTarget.dataset.page;
            const totalPages = Math.ceil(filteredUsers.length / entriesPerPage);

            switch(page) {
                case 'first':
                    currentPage = 1;
                    break;
                case 'prev':
                    currentPage = Math.max(1, currentPage - 1);
                    break;
                case 'next':
                    currentPage = Math.min(totalPages, currentPage + 1);
                    break;
                case 'last':
                    currentPage = totalPages;
                    break;
                default:
                    currentPage = parseInt(page);
            }

            renderUsersTable();
        }

        function handleSearch() {
            const searchTerm = elements.searchInput.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                filteredUsers = [...allUsers];
            } else {
                filteredUsers = allUsers.filter(user => 
                    (user.username && user.username.toLowerCase().includes(searchTerm)) ||
                    (user.fullName && user.fullName.toLowerCase().includes(searchTerm)) ||
                    (user.email && user.email.toLowerCase().includes(searchTerm)) ||
                    (user.department && user.department.toLowerCase().includes(searchTerm))
                );
            }

            currentPage = 1;
            renderUsersTable();
        }

        function handleEntriesChange() {
            entriesPerPage = parseInt(elements.entriesSelect.value);
            currentPage = 1;
            renderUsersTable();
        }

        // =============================================
        // MODAL FUNCTIONS
        // =============================================
        function openEditModal(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) {
                UIUtils.showToast('User not found', 'error');
                return;
            }

            currentEditUserId = userId;
            elements.editUserId.value = userId;
            elements.editFullName.value = user.fullName || '';
            elements.editPassword.value = '';
            elements.editEmail.value = user.email || '';
            elements.editDepartment.value = user.department || '';
            elements.editStatus.value = user.status || 'ACTIVE';

            // Set role button - single selection (select first matching role)
            const roleButtons = document.querySelectorAll('#editUserForm .role-btn');
            roleButtons.forEach(btn => btn.classList.remove('role-btn-active'));
            
            // Find and select the user's current role (only one)
            if (user.roles && user.roles.length > 0) {
                const userRole = user.roles[0]; // Get first role
                const roleName = userRole.replace('ROLE_', ''); // Remove ROLE_ prefix if exists
                const matchingBtn = document.querySelector(`#editUserForm .role-btn[data-role="${roleName}"]`);
                if (matchingBtn) {
                    matchingBtn.classList.add('role-btn-active');
                }
            }

            elements.editModal.style.display = 'flex';
        }

        function closeEditModal() {
            elements.editModal.style.display = 'none';
            currentEditUserId = null;
            elements.editForm.reset();
            document.querySelectorAll('#editUserForm .role-btn').forEach(btn => {
                btn.classList.remove('role-btn-active');
            });
        }

        function openDeleteModal(userId) {
            const user = allUsers.find(u => u.id === userId);
            if (!user) {
                UIUtils.showToast('User not found', 'error');
                return;
            }

            currentDeleteUserId = userId;
            elements.deleteUserIdHidden.value = userId;
            elements.deleteUserId.textContent = UIUtils.formatId(user.id);
            elements.deleteUsername.textContent = user.username || '-';
            elements.deleteFullName.textContent = user.fullName || '-';
            elements.deleteEmail.textContent = user.email || '-';
            elements.deleteDepartment.textContent = user.department || '-';
            elements.deleteStatus.textContent = user.status || '-';
            elements.deleteCreatedAt.textContent = UIUtils.formatDate(user.createdAt);

            // Render roles
            elements.deleteRoles.innerHTML = '';
            if (user.roles && user.roles.length > 0) {
                user.roles.forEach(role => {
                    const badge = document.createElement('span');
                    badge.className = 'role-badge';
                    const roleName = role.replace('ROLE_', '').replace('_', ' ');
                    
                    if (roleName === 'ADMIN') {
                        badge.classList.add('role-admin');
                    } else if (roleName === 'IT SUPPORT' || roleName === 'IT_SUPPORT') {
                        badge.classList.add('role-support');
                    } else {
                        badge.classList.add('role-employee');
                    }
                    
                    badge.textContent = roleName;
                    elements.deleteRoles.appendChild(badge);
                });
            }

            elements.deleteModal.style.display = 'flex';
        }

        function closeDeleteModal() {
            elements.deleteModal.style.display = 'none';
            currentDeleteUserId = null;
        }

        // =============================================
        // API OPERATIONS
        // =============================================
        async function loadUsers() {
            showState('loading');

            try {
                const response = await ApiService.getAllUsers();
                allUsers = response.data || [];
                filteredUsers = [...allUsers];
                renderUsersTable();
            } catch (error) {
                console.error('Failed to load users:', error);
                document.getElementById('errorMessage').textContent = error.message || 'Failed to load users';
                showState('error');
            }
        }

        async function handleUpdateUser(e) {
            e.preventDefault();

            if (!currentEditUserId) {
                UIUtils.showToast('No user selected', 'error');
                return;
            }

            // Get selected role (single selection)
            const selectedRoleBtn = document.querySelector('#editUserForm .role-btn-active');
            if (!selectedRoleBtn) {
                UIUtils.showToast('Please select a role', 'warning');
                return;
            }

            const submitBtn = elements.btnUpdateUser;
            submitBtn.classList.add('loading');
            submitBtn.disabled = true;

            try {
                // Get current user to compare roles
                const currentUser = allUsers.find(u => u.id === currentEditUserId);
                let selectedRole = selectedRoleBtn.dataset.role;
                // Always send with ROLE_ prefix for backend
                if (!selectedRole.startsWith('ROLE_')) {
                    selectedRole = 'ROLE_' + selectedRole;
                }

                // ========== 1. Update User Info (without roles) ==========
                const updateData = {
                    fullName: elements.editFullName.value,
                    email: elements.editEmail.value,
                    department: elements.editDepartment.value,
                    status: elements.editStatus.value
                };

                // Only include password if provided
                if (elements.editPassword.value) {
                    updateData.password = elements.editPassword.value;
                }

                // Call Update User API
                await ApiService.updateUser(currentEditUserId, updateData);

                // ========== 2. Assign Role (separate API) ==========
                // Always call assign roles API with the selected role (with prefix)
                await ApiService.assignRoles(currentEditUserId, [selectedRole]);

                UIUtils.showToast('User updated successfully', 'success');
                closeEditModal();
                await loadUsers();
            } catch (error) {
                console.error('Failed to update user:', error);
                UIUtils.showToast(error.message || 'Failed to update user', 'error');
            } finally {
                submitBtn.classList.remove('loading');
                submitBtn.disabled = false;
            }
        }

        async function handleDeleteUser() {
            if (!currentDeleteUserId) {
                UIUtils.showToast('No user selected', 'error');
                return;
            }

            const deleteBtn = elements.btnConfirmDelete;
            deleteBtn.classList.add('loading');
            deleteBtn.disabled = true;

            try {
                await ApiService.deleteUser(currentDeleteUserId);
                UIUtils.showToast('User deleted successfully', 'success');
                closeDeleteModal();
                await loadUsers();
            } catch (error) {
                console.error('Failed to delete user:', error);
                UIUtils.showToast(error.message || 'Failed to delete user', 'error');
            } finally {
                deleteBtn.classList.remove('loading');
                deleteBtn.disabled = false;
            }
        }

        function handleLogout() {
            AuthService.removeToken();
            AuthService.redirectToLogin();
        }

        // =============================================
        // INITIALIZATION
        // =============================================
        function initializeEventListeners() {
            // Sidebar toggle
            elements.sidebarToggle.addEventListener('click', () => {
                elements.sidebar.classList.toggle('collapsed');
                elements.mainContent.classList.toggle('expanded');
            });

            // Search
            elements.searchInput.addEventListener('input', handleSearch);
            elements.searchInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') handleSearch();
            });

            // Entries select
            elements.entriesSelect.addEventListener('change', handleEntriesChange);

            // Retry button
            elements.retryBtn.addEventListener('click', loadUsers);

            // Edit modal
            elements.closeEditModal.addEventListener('click', closeEditModal);
            elements.editModal.addEventListener('click', (e) => {
                if (e.target === elements.editModal) closeEditModal();
            });
            elements.editForm.addEventListener('submit', handleUpdateUser);

            // Role buttons - single selection only (radio button behavior)
            document.querySelectorAll('#editUserForm .role-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Remove active class from all role buttons
                    document.querySelectorAll('#editUserForm .role-btn').forEach(b => {
                        b.classList.remove('role-btn-active');
                    });
                    // Add active class to clicked button
                    btn.classList.add('role-btn-active');
                });
            });

            // Delete modal
            elements.closeDeleteModal.addEventListener('click', closeDeleteModal);
            elements.btnCancelDelete.addEventListener('click', closeDeleteModal);
            elements.deleteModal.addEventListener('click', (e) => {
                if (e.target === elements.deleteModal) closeDeleteModal();
            });
            elements.btnConfirmDelete.addEventListener('click', handleDeleteUser);

            // Logout
            elements.btnLogout.addEventListener('click', handleLogout);

            // User profile button
            document.getElementById('btnUserProfile')?.addEventListener('click', () => {
                if (typeof showUserProfileModal === 'function') {
                    showUserProfileModal();
                } else {
                    const user = JSON.parse(localStorage.getItem('user_info') || '{}');
                    alert(`User Profile\n\nUsername: ${user.username || 'N/A'}\nFull Name: ${user.fullName || 'N/A'}\nEmail: ${user.email || 'N/A'}`);
                }
            });

            // Escape key to close modals
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (elements.editModal.style.display === 'flex') closeEditModal();
                    if (elements.deleteModal.style.display === 'flex') closeDeleteModal();
                }
            });
        }

        function displayCurrentUser() {
            const userInfo = AuthService.getUserInfo();
            if (userInfo) {
                elements.currentUserInfo.textContent = userInfo.fullName || userInfo.username || '';
            }
        }

        function checkAuthentication() {
            if (!AuthService.isAuthenticated()) {
                AuthService.redirectToLogin();
                return false;
            }

            // Check if user has ADMIN role
            if (!AuthService.hasRole('ADMIN') && !AuthService.hasRole('ROLE_ADMIN')) {
                UIUtils.showToast('Access denied. Admin privileges required.', 'error');
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
                return false;
            }

            return true;
        }

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            if (!checkAuthentication()) return;
            
            displayCurrentUser();
            initializeEventListeners();
            loadUsers();
        });
    </script>

    <!-- Insert user profile modal component -->
    <div th:insert="component/user-profile :: userProfile"></div>
</body>
</html>
