<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Helpdesk - Tickets Management</title>
    
    <!-- External Stylesheets -->
    <link rel="stylesheet" href="/css/header.css">
    <link rel="stylesheet" href="/css/admin/admin-sidebar.css">
    <link rel="stylesheet" href="/css/admin/admin-tickets.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header Component -->
    <header class="header">
        <div class="header-content">
            <h1 class="header-title">IT Helpdesk</h1>
            <div class="header-actions">
                <button class="btn-icon btn-user" aria-label="User profile">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                    </svg>
                </button>
                <button class="btn-icon btn-logout" aria-label="Logout">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Sidebar Component -->
    <aside class="sidebar">
        <nav class="sidebar-nav">
            <button class="sidebar-toggle" aria-label="Toggle sidebar">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            
            <ul class="sidebar-menu">
                <li class="menu-item">
                    <a href="/admin/dashboard" class="menu-link" title="Dashboard">
                        <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                        <span class="menu-text">Dashboard</span>
                    </a>
                </li>
                
                <li class="menu-item active">
                    <a href="/admin/tickets" class="menu-link" title="Tickets">
                        <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        <span class="menu-text">Tickets</span>
                    </a>
                </li>
                
                <li class="menu-item">
                    <a href="/admin/users" class="menu-link" title="Users">
                        <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <span class="menu-text">Users</span>
                    </a>
                </li>
                
                <li class="menu-item">
                    <a href="/admin/reports" class="menu-link" title="Reports">
                        <svg class="menu-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                        <span class="menu-text">Reports</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="tickets-container">
            <!-- Page Header -->
            <div class="page-header">
                <h2 class="page-title">Tickets</h2>
            </div>

            <!-- Search and Filter Section -->
            <div class="tickets-controls">
                <div class="search-wrapper">
                    <input type="text" class="search-input" placeholder="Find ticket" id="searchInput">
                    <button class="search-btn" aria-label="Search">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                    </button>
                </div>

                <div class="entries-control">
                    <span class="entries-label">Show:</span>
                    <select class="entries-select" id="entriesSelect">
                        <option value="10" selected>10</option>
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                    <span class="entries-label">Entries</span>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="loading-state" style="display: none;">
                <div class="spinner"></div>
                <p>Loading tickets...</p>
            </div>

            <!-- Error State -->
            <div id="errorState" class="error-state" style="display: none;">
                <p id="errorMessage">Failed to load tickets</p>
                <button onclick="TicketsManager.fetchTickets()" class="retry-btn">Retry</button>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                </svg>
                <p>No tickets found</p>
            </div>

            <!-- Tickets Table -->
            <div class="table-wrapper" id="tableWrapper" style="display: none;">
                <table class="tickets-table">
                    <thead>
                        <tr>
                            <th class="th-id">ID</th>
                            <th class="th-title">Title</th>
                            <th class="th-description">Description</th>
                            <th class="th-category">Category</th>
                            <th class="th-priority">Priority</th>
                            <th class="th-created">Created At</th>
                            <th class="th-status">Status</th>
                            <th class="th-action">Action</th>
                        </tr>
                    </thead>
                    <tbody id="ticketsTableBody">
                        <!-- Tickets will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination-wrapper" id="paginationWrapper" style="display: none;">
                <div class="pagination-info" id="paginationInfo">
                    Showing 0 to 0 of 0 entries
                </div>
                <div class="pagination-controls" id="paginationControls">
                    <!-- Pagination buttons will be dynamically inserted here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Modal: Assign Ticket -->
    <div class="modal-overlay" id="assignTicketModal">
        <div class="modal-container">
            <div class="modal-header modal-header-primary">
                <h2 class="modal-title">Assign Ticket</h2>
                <button class="modal-close" aria-label="Close modal" onclick="ModalManager.closeModal('assignTicketModal')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form class="ticket-form" id="assignTicketForm">
                    <div class="form-group">
                        <label class="form-label">ID</label>
                        <input type="text" class="form-input" id="assign-id" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-input" id="assign-title" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" rows="3" id="assign-description" readonly></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <input type="text" class="form-input" id="assign-category" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <input type="text" class="form-input" id="assign-priority" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Create at</label>
                        <input type="text" class="form-input" id="assign-created" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <input type="text" class="form-input" id="assign-status" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Employee</label>
                        <input type="text" class="form-input" id="assign-employee" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label-section">IT Support</label>
                    </div>
                    <div class="form-group">
                        <select class="form-select" id="assign-support">
                            <option value="">Select IT Support</option>
                            <option value="john">John IT Support</option>
                            <option value="jane">Jane IT Support</option>
                            <option value="bob">Bob IT Support</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Comment:</label>
                        <textarea class="form-textarea" rows="4" id="assign-comment" placeholder="Add your comment here..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer modal-footer-primary">
                <button class="btn-secondary" type="button" onclick="ModalManager.closeModal('assignTicketModal')">Cancel</button>
                <button class="btn-primary" type="button" onclick="ModalManager.submitAssign()">Update</button>
            </div>
        </div>
    </div>

    <!-- Modal: Delete Ticket -->
    <div class="modal-overlay" id="deleteTicketModal">
        <div class="modal-container">
            <div class="modal-header modal-header-danger">
                <h2 class="modal-title">Delete Ticket</h2>
                <button class="modal-close" aria-label="Close modal" onclick="ModalManager.closeModal('deleteTicketModal')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="ticket-form">
                    <div class="form-group">
                        <label class="form-label">ID</label>
                        <input type="text" class="form-input" id="delete-id" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Title</label>
                        <input type="text" class="form-input" id="delete-title" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Description</label>
                        <textarea class="form-textarea" rows="3" id="delete-description" readonly></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <input type="text" class="form-input" id="delete-category" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Priority</label>
                        <input type="text" class="form-input" id="delete-priority" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Create at</label>
                        <input type="text" class="form-input" id="delete-created" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <input type="text" class="form-input" id="delete-status" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Employee</label>
                        <input type="text" class="form-input" id="delete-employee" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label-section">IT Support</label>
                    </div>
                    <div class="form-group">
                        <input type="text" class="form-input" id="delete-support" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Comment:</label>
                        <textarea class="form-textarea" rows="4" id="delete-comment" readonly></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer modal-footer-danger">
                <button class="btn-secondary" type="button" onclick="ModalManager.closeModal('deleteTicketModal')">Cancel</button>
                <button class="btn-danger" type="button" onclick="ModalManager.submitDelete()">Delete</button>
            </div>
        </div>
    </div>

    <!-- Modal: View Ticket -->
    <div class="modal-overlay" id="viewTicketModal">
        <div class="modal-container">
            <div class="modal-header modal-header-info">
                <h2 class="modal-title">View Ticket</h2>
                <button class="modal-close" aria-label="Close modal" onclick="ModalManager.closeModal('viewTicketModal')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="ticket-details">
                    <div class="detail-group">
                        <label class="detail-label">ID</label>
                        <div class="detail-value" id="view-id"></div>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label">Title</label>
                        <div class="detail-value" id="view-title"></div>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label">Description</label>
                        <div class="detail-value detail-value-text" id="view-description"></div>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label">Category</label>
                        <div class="detail-value" id="view-category"></div>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label">Priority</label>
                        <div class="detail-value" id="view-priority"></div>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label">Create at</label>
                        <div class="detail-value" id="view-created"></div>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label">Status</label>
                        <div class="detail-value" id="view-status"></div>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label">Employee</label>
                        <div class="detail-value" id="view-employee"></div>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label-section">IT Support</label>
                    </div>
                    <div class="detail-group">
                        <div class="detail-value" id="view-support"></div>
                    </div>
                    <div class="detail-group">
                        <label class="detail-label">Comment:</label>
                        <div class="detail-value detail-value-text" id="view-comment"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer center">
                <button class="btn-close" type="button" onclick="ModalManager.closeModal('viewTicketModal')">Close</button>
            </div>
        </div>
    </div>

    <script>
        /**
         * Authentication Module - Handles JWT token management
         */
        const AuthManager = {
            STORAGE_KEYS: {
                TOKEN: 'auth_token',
                TOKEN_TYPE: 'token_type',
                USER: 'user_info'
            },

            getToken() {
                return localStorage.getItem(this.STORAGE_KEYS.TOKEN);
            },

            getTokenType() {
                return localStorage.getItem(this.STORAGE_KEYS.TOKEN_TYPE) || 'Bearer';
            },

            getAuthHeader() {
                const token = this.getToken();
                const tokenType = this.getTokenType();
                return token ? `${tokenType} ${token}` : null;
            },

            getUserInfo() {
                const userStr = localStorage.getItem(this.STORAGE_KEYS.USER);
                try {
                    return userStr ? JSON.parse(userStr) : null;
                } catch {
                    return null;
                }
            },

            isAuthenticated() {
                const token = this.getToken();
                if (!token) return false;

                try {
                    const parts = token.split('.');
                    if (parts.length !== 3) {
                        this.logout();
                        return false;
                    }

                    const payload = JSON.parse(atob(parts[1]));
                    const expiration = payload.exp * 1000;

                    if (Date.now() >= expiration) {
                        this.logout();
                        return false;
                    }

                    return true;
                } catch {
                    this.logout();
                    return false;
                }
            },

            logout() {
                localStorage.removeItem(this.STORAGE_KEYS.TOKEN);
                localStorage.removeItem(this.STORAGE_KEYS.TOKEN_TYPE);
                localStorage.removeItem(this.STORAGE_KEYS.USER);
                window.location.href = '/login';
            },

            requireAuth() {
                if (!this.isAuthenticated()) {
                    window.location.href = '/login';
                    return false;
                }
                return true;
            }
        };

        /**
         * Tickets Manager - Handles all ticket-related operations using Fetch API
         */
        const TicketsManager = {
            state: {
                tickets: [],
                filteredTickets: [],
                itSupportUsers: [],
                currentPage: 1,
                entriesPerPage: 10,
                searchTerm: '',
                isLoading: false,
                error: null
            },

            API_BASE_URL: '/api/tickets',
            USERS_API_URL: '/api/users',

            init() {
                if (!AuthManager.requireAuth()) {
                    return;
                }
                this.bindEvents();
                this.fetchTickets();
                this.fetchITSupportUsers();
            },

            bindEvents() {
                const sidebar = document.querySelector('.sidebar');
                const toggleBtn = document.querySelector('.sidebar-toggle');
                const mainContent = document.querySelector('.main-content');

                toggleBtn?.addEventListener('click', () => {
                    sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('expanded');
                });

                const searchInput = document.getElementById('searchInput');
                searchInput?.addEventListener('input', (e) => {
                    this.state.searchTerm = e.target.value.toLowerCase();
                    this.state.currentPage = 1;
                    this.filterAndRenderTickets();
                });

                const entriesSelect = document.getElementById('entriesSelect');
                entriesSelect?.addEventListener('change', (e) => {
                    this.state.entriesPerPage = parseInt(e.target.value);
                    this.state.currentPage = 1;
                    this.filterAndRenderTickets();
                });

                const logoutBtn = document.querySelector('.btn-logout');
                logoutBtn?.addEventListener('click', () => {
                    AuthManager.logout();
                });
            },

            /**
             * Fetch all tickets from the API
             */
            async fetchTickets() {
                this.showLoading();

                const authHeader = AuthManager.getAuthHeader();
                if (!authHeader) {
                    AuthManager.logout();
                    return;
                }

                try {
                    const response = await fetch(this.API_BASE_URL, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'Authorization': authHeader
                        }
                    });

                    if (response.status === 401) {
                        AuthManager.logout();
                        return;
                    }

                    if (response.status === 403) {
                        throw new Error('You do not have permission to view tickets');
                    }

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    
                    if (result.success && Array.isArray(result.data)) {
                        this.state.tickets = result.data;
                        this.state.error = null;
                        this.filterAndRenderTickets();
                    } else if (Array.isArray(result)) {
                        this.state.tickets = result;
                        this.state.error = null;
                        this.filterAndRenderTickets();
                    } else {
                        throw new Error('Invalid response format');
                    }
                } catch (error) {
                    console.error('Error fetching tickets:', error);
                    this.state.error = error.message;
                    this.showError(error.message);
                }
            },

            /**
             * Fetch IT Support users from API
             */
            async fetchITSupportUsers() {
                const authHeader = AuthManager.getAuthHeader();
                if (!authHeader) return;

                try {
                    const response = await fetch(this.USERS_API_URL, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'Authorization': authHeader
                        }
                    });

                    if (!response.ok) {
                        console.error('Failed to fetch users');
                        return;
                    }

                    const result = await response.json();
                    const users = result.success ? result.data : result;
                    
                    // Filter IT Support users
                    this.state.itSupportUsers = users.filter(user => 
                        user.roles && user.roles.some(role => 
                            role.name === 'ROLE_IT_SUPPORT' || role === 'ROLE_IT_SUPPORT'
                        )
                    );
                    
                    this.populateITSupportDropdown();
                } catch (error) {
                    console.error('Error fetching IT Support users:', error);
                }
            },

            /**
             * Populate IT Support dropdown in Assign Modal
             */
            populateITSupportDropdown() {
                const selectElement = document.getElementById('assign-support');
                if (!selectElement) return;

                selectElement.innerHTML = '<option value="">Select IT Support</option>';
                
                this.state.itSupportUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.fullName || user.username;
                    selectElement.appendChild(option);
                });
            },

            /**
             * Get ticket by ID using API
             */
            async getTicketById(ticketId) {
                const authHeader = AuthManager.getAuthHeader();
                if (!authHeader) {
                    AuthManager.logout();
                    return null;
                }

                try {
                    const response = await fetch(`${this.API_BASE_URL}/${ticketId}`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'Authorization': authHeader
                        }
                    });

                    if (response.status === 401) {
                        AuthManager.logout();
                        return null;
                    }

                    if (!response.ok) {
                        throw new Error(`Failed to fetch ticket: ${response.status}`);
                    }

                    const result = await response.json();
                    return result.success ? result.data : result;
                } catch (error) {
                    console.error('Error fetching ticket:', error);
                    this.showToast('Failed to fetch ticket details', 'error');
                    return null;
                }
            },

            /**
             * Assign ticket using API
             */
            async assignTicketAPI(ticketId, assigneeId) {
                const authHeader = AuthManager.getAuthHeader();
                if (!authHeader) {
                    AuthManager.logout();
                    return false;
                }

                try {
                    const response = await fetch(`${this.API_BASE_URL}/${ticketId}/assign`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'Authorization': authHeader
                        },
                        body: JSON.stringify({ assigneeId: assigneeId })
                    });

                    if (response.status === 401) {
                        AuthManager.logout();
                        return false;
                    }

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to assign ticket');
                    }

                    const result = await response.json();
                    return result.success !== false;
                } catch (error) {
                    console.error('Error assigning ticket:', error);
                    throw error;
                }
            },

            /**
             * Delete ticket using API
             */
            async deleteTicketAPI(ticketId) {
                const authHeader = AuthManager.getAuthHeader();
                if (!authHeader) {
                    AuthManager.logout();
                    return false;
                }

                try {
                    const response = await fetch(`${this.API_BASE_URL}/${ticketId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                            'Authorization': authHeader
                        }
                    });

                    if (response.status === 401) {
                        AuthManager.logout();
                        return false;
                    }

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Failed to delete ticket');
                    }

                    return true;
                } catch (error) {
                    console.error('Error deleting ticket:', error);
                    throw error;
                }
            },

            filterAndRenderTickets() {
                const { tickets, searchTerm } = this.state;

                this.state.filteredTickets = tickets.filter(ticket => {
                    if (!searchTerm) return true;
                    
                    const searchableFields = [
                        ticket.id,
                        ticket.title,
                        ticket.description,
                        ticket.category,
                        ticket.priority,
                        ticket.status,
                        ticket.createdBy?.fullName,
                        ticket.assignedTo?.fullName
                    ].filter(Boolean).map(field => String(field).toLowerCase());

                    return searchableFields.some(field => field.includes(searchTerm));
                });

                this.renderTickets();
                this.renderPagination();
            },

            renderTickets() {
                const { filteredTickets, currentPage, entriesPerPage } = this.state;
                const tableBody = document.getElementById('ticketsTableBody');
                const tableWrapper = document.getElementById('tableWrapper');
                const emptyState = document.getElementById('emptyState');

                this.hideLoading();
                this.hideError();

                if (filteredTickets.length === 0) {
                    tableWrapper.style.display = 'none';
                    emptyState.style.display = 'flex';
                    document.getElementById('paginationWrapper').style.display = 'none';
                    return;
                }

                emptyState.style.display = 'none';
                tableWrapper.style.display = 'block';
                document.getElementById('paginationWrapper').style.display = 'flex';

                const startIndex = (currentPage - 1) * entriesPerPage;
                const endIndex = Math.min(startIndex + entriesPerPage, filteredTickets.length);
                const paginatedTickets = filteredTickets.slice(startIndex, endIndex);

                tableBody.innerHTML = paginatedTickets.map(ticket => this.createTicketRow(ticket)).join('');
                this.addRowHoverEffects();
            },

            createTicketRow(ticket) {
                const shortId = ticket.id ? ticket.id.substring(0, 8) : 'N/A';
                const title = this.truncateText(ticket.title || 'N/A', 20);
                const description = this.truncateText(ticket.description || 'N/A', 20);
                const category = ticket.category || 'N/A';
                const priority = ticket.priority || 'N/A';
                const status = ticket.status || 'OPEN';
                const createdAt = this.formatDateTime(ticket.createdAt);
                const statusClass = this.getStatusClass(status);

                return `
                    <tr class="ticket-row" data-id="${ticket.id}">
                        <td class="td-id" title="${ticket.id}">${shortId}</td>
                        <td class="td-title" title="${ticket.title || ''}">${title}</td>
                        <td class="td-description" title="${ticket.description || ''}">${description}</td>
                        <td class="td-category">${category}</td>
                        <td class="td-priority priority-${priority.toLowerCase()}">${priority}</td>
                        <td class="td-created">${createdAt}</td>
                        <td class="td-status">
                            <span class="status-badge ${statusClass}">${this.formatStatus(status)}</span>
                        </td>
                        <td class="td-action">
                            <div class="action-buttons">
                                <button class="action-btn action-btn-assign" title="Assign Ticket" onclick="TicketsManager.openAssignTicket('${ticket.id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M12 20h9"></path>
                                        <path d="M16.5 3.5a2.121 2.121 0 1 1 3 3L7 19l-4 1 1-4 12.5-12.5z"></path>
                                    </svg>
                                </button>
                                <button class="action-btn action-btn-delete" title="Delete Ticket" onclick="TicketsManager.openDeleteTicket('${ticket.id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
                                        <line x1="10" y1="11" x2="10" y2="17"></line>
                                        <line x1="14" y1="11" x2="14" y2="17"></line>
                                    </svg>
                                </button>
                                <button class="action-btn action-btn-view" title="View Details" onclick="TicketsManager.openViewTicket('${ticket.id}')">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            },

            renderPagination() {
                const { filteredTickets, currentPage, entriesPerPage } = this.state;
                const totalPages = Math.ceil(filteredTickets.length / entriesPerPage);
                const startIndex = (currentPage - 1) * entriesPerPage + 1;
                const endIndex = Math.min(currentPage * entriesPerPage, filteredTickets.length);

                document.getElementById('paginationInfo').textContent = 
                    `Showing ${filteredTickets.length > 0 ? startIndex : 0} to ${endIndex} of ${filteredTickets.length} entries`;

                const paginationControls = document.getElementById('paginationControls');
                let paginationHTML = '';

                paginationHTML += `
                    <button class="pagination-btn" ${currentPage === 1 ? 'disabled' : ''} 
                            onclick="TicketsManager.goToPage(${currentPage - 1})" aria-label="Previous page">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="11 17 6 12 11 7"></polyline>
                            <polyline points="18 17 13 12 18 7"></polyline>
                        </svg>
                    </button>
                `;

                const maxVisiblePages = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

                if (endPage - startPage + 1 < maxVisiblePages) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }

                for (let i = startPage; i <= endPage; i++) {
                    paginationHTML += `
                        <button class="pagination-btn pagination-number ${i === currentPage ? 'active' : ''}" 
                                onclick="TicketsManager.goToPage(${i})">${i}</button>
                    `;
                }

                paginationHTML += `
                    <button class="pagination-btn" ${currentPage === totalPages || totalPages === 0 ? 'disabled' : ''} 
                            onclick="TicketsManager.goToPage(${currentPage + 1})" aria-label="Next page">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="13 17 18 12 13 7"></polyline>
                            <polyline points="6 17 11 12 6 7"></polyline>
                        </svg>
                    </button>
                `;

                paginationControls.innerHTML = paginationHTML;
            },

            goToPage(page) {
                const totalPages = Math.ceil(this.state.filteredTickets.length / this.state.entriesPerPage);
                if (page >= 1 && page <= totalPages) {
                    this.state.currentPage = page;
                    this.renderTickets();
                    this.renderPagination();
                    document.getElementById('tableWrapper')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            },

            addRowHoverEffects() {
                const rows = document.querySelectorAll('.ticket-row');
                rows.forEach(row => {
                    row.addEventListener('mouseenter', function() {
                        this.style.transform = 'translateX(4px)';
                    });
                    row.addEventListener('mouseleave', function() {
                        this.style.transform = 'translateX(0)';
                    });
                });
            },

            // Utility functions
            truncateText(text, maxLength) {
                if (!text) return 'N/A';
                return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
            },

            formatDateTime(dateTimeStr) {
                if (!dateTimeStr) return 'N/A';
                try {
                    const date = new Date(dateTimeStr);
                    const hours = date.getHours().toString().padStart(2, '0');
                    const minutes = date.getMinutes().toString().padStart(2, '0');
                    const seconds = date.getSeconds().toString().padStart(2, '0');
                    const day = date.getDate().toString().padStart(2, '0');
                    const month = (date.getMonth() + 1).toString().padStart(2, '0');
                    const year = date.getFullYear();
                    return `${hours}:${minutes}:${seconds} ${day}/${month}/${year}`;
                } catch {
                    return 'N/A';
                }
            },

            formatStatus(status) {
                if (!status) return 'OPEN';
                return status.replace('_', ' ');
            },

            getStatusClass(status) {
                const statusMap = {
                    'OPEN': 'status-open',
                    'ASSIGNED': 'status-assigned',
                    'IN_PROGRESS': 'status-progress',
                    'RESOLVED': 'status-resolved',
                    'CLOSED': 'status-closed'
                };
                return statusMap[status] || 'status-open';
            },

            // UI State management
            showLoading() {
                this.state.isLoading = true;
                document.getElementById('loadingState').style.display = 'flex';
                document.getElementById('tableWrapper').style.display = 'none';
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('errorState').style.display = 'none';
                document.getElementById('paginationWrapper').style.display = 'none';
            },

            hideLoading() {
                this.state.isLoading = false;
                document.getElementById('loadingState').style.display = 'none';
            },

            showError(message) {
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('tableWrapper').style.display = 'none';
                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('errorState').style.display = 'flex';
                document.getElementById('errorMessage').textContent = message || 'Failed to load tickets';
                document.getElementById('paginationWrapper').style.display = 'none';
            },

            hideError() {
                document.getElementById('errorState').style.display = 'none';
            },

            showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    padding: 16px 24px;
                    border-radius: 8px;
                    color: white;
                    font-weight: 500;
                    z-index: 10000;
                    animation: slideIn 0.3s ease;
                    background-color: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#f59e0b'};
                `;
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },

            // Action handlers - Open modals with API data
            async openViewTicket(ticketId) {
                const ticket = await this.getTicketById(ticketId);
                if (ticket) {
                    ModalManager.openViewModal(ticket);
                }
            },

            async openAssignTicket(ticketId) {
                const ticket = await this.getTicketById(ticketId);
                if (ticket) {
                    ModalManager.openAssignModal(ticket);
                }
            },

            async openDeleteTicket(ticketId) {
                const ticket = await this.getTicketById(ticketId);
                if (ticket) {
                    ModalManager.openDeleteModal(ticket);
                }
            }
        };

        /**
         * Modal Manager - Handles all modal operations with API integration
         */
        const ModalManager = {
            currentTicket: null,
            isSubmitting: false,

            openAssignModal(ticket) {
                this.currentTicket = ticket;
                
                document.getElementById('assign-id').value = ticket.id || '';
                document.getElementById('assign-title').value = ticket.title || '';
                document.getElementById('assign-description').value = ticket.description || '';
                document.getElementById('assign-category').value = ticket.category || '';
                document.getElementById('assign-priority').value = ticket.priority || '';
                document.getElementById('assign-created').value = TicketsManager.formatDateTime(ticket.createdAt) || '';
                document.getElementById('assign-status').value = TicketsManager.formatStatus(ticket.status) || '';
                document.getElementById('assign-employee').value = ticket.createdBy?.fullName || 'N/A';
                
                // Set current assigned support if exists
                const supportSelect = document.getElementById('assign-support');
                if (ticket.assignedTo?.id) {
                    supportSelect.value = ticket.assignedTo.id;
                } else {
                    supportSelect.value = '';
                }
                
                document.getElementById('assign-comment').value = '';
                
                this.openModal('assignTicketModal');
            },

            openDeleteModal(ticket) {
                this.currentTicket = ticket;
                
                document.getElementById('delete-id').value = ticket.id || '';
                document.getElementById('delete-title').value = ticket.title || '';
                document.getElementById('delete-description').value = ticket.description || '';
                document.getElementById('delete-category').value = ticket.category || '';
                document.getElementById('delete-priority').value = ticket.priority || '';
                document.getElementById('delete-created').value = TicketsManager.formatDateTime(ticket.createdAt) || '';
                document.getElementById('delete-status').value = TicketsManager.formatStatus(ticket.status) || '';
                document.getElementById('delete-employee').value = ticket.createdBy?.fullName || 'N/A';
                document.getElementById('delete-support').value = ticket.assignedTo?.fullName || 'N/A';
                document.getElementById('delete-comment').value = ticket.comments?.length > 0 ? ticket.comments[ticket.comments.length - 1].content : '';
                
                this.openModal('deleteTicketModal');
            },

            openViewModal(ticket) {
                this.currentTicket = ticket;
                
                document.getElementById('view-id').textContent = ticket.id || '';
                document.getElementById('view-title').textContent = ticket.title || '';
                document.getElementById('view-description').textContent = ticket.description || '';
                document.getElementById('view-category').textContent = ticket.category || '';
                document.getElementById('view-priority').textContent = ticket.priority || '';
                document.getElementById('view-created').textContent = TicketsManager.formatDateTime(ticket.createdAt) || '';
                document.getElementById('view-status').textContent = TicketsManager.formatStatus(ticket.status) || '';
                document.getElementById('view-employee').textContent = ticket.createdBy?.fullName || 'N/A';
                document.getElementById('view-support').textContent = ticket.assignedTo?.fullName || 'N/A';
                document.getElementById('view-comment').textContent = ticket.comments?.length > 0 ? ticket.comments[ticket.comments.length - 1].content : 'No comments';
                
                this.openModal('viewTicketModal');
            },

            openModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            },

            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            },

            async submitAssign() {
                if (this.isSubmitting) return;
                
                const supportId = document.getElementById('assign-support').value;
                
                if (!supportId) {
                    TicketsManager.showToast('Please select an IT Support staff member', 'warning');
                    return;
                }

                this.isSubmitting = true;
                const submitBtn = document.querySelector('#assignTicketModal .btn-primary');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Updating...';
                submitBtn.disabled = true;

                try {
                    await TicketsManager.assignTicketAPI(this.currentTicket.id, supportId);
                    TicketsManager.showToast('Ticket assigned successfully!', 'success');
                    this.closeModal('assignTicketModal');
                    
                    // Refresh tickets list
                    await TicketsManager.fetchTickets();
                } catch (error) {
                    TicketsManager.showToast(error.message || 'Failed to assign ticket', 'error');
                } finally {
                    this.isSubmitting = false;
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            },

            async submitDelete() {
                if (this.isSubmitting) return;
                
                if (!confirm('Are you sure you want to delete this ticket? This action cannot be undone.')) {
                    return;
                }

                this.isSubmitting = true;
                const submitBtn = document.querySelector('#deleteTicketModal .btn-danger');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Deleting...';
                submitBtn.disabled = true;

                try {
                    await TicketsManager.deleteTicketAPI(this.currentTicket.id);
                    TicketsManager.showToast('Ticket deleted successfully!', 'success');
                    this.closeModal('deleteTicketModal');
                    
                    // Refresh tickets list
                    await TicketsManager.fetchTickets();
                } catch (error) {
                    TicketsManager.showToast(error.message || 'Failed to delete ticket', 'error');
                } finally {
                    this.isSubmitting = false;
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            }
        };

        // Close modals on overlay click
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                const modalId = e.target.id;
                ModalManager.closeModal(modalId);
            }
        });

        // Close modals on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                ['assignTicketModal', 'deleteTicketModal', 'viewTicketModal'].forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (modal && modal.classList.contains('active')) {
                        ModalManager.closeModal(modalId);
                    }
                });
            }
        });

        // Add toast animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            TicketsManager.init();
        });
    </script>
</body>
</html>
